<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>flowr</title>
  <link rel="icon" type="image/png" href="assets/favicon_io/favicon.ico">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            slate: {
              850: '#151F32',
              950: '#020617',
            }
          }
        }
      }
    }
  </script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/src/dom-to-image.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>

  <style>
    :root {
      --primary: #1b4f55;
      --primary-rgb: 27, 79, 85;
      --primary-strong: #10393f;
      --primary-soft: rgba(27, 79, 85, 0.14);
      --app-bg: #f7f9fa;
      --app-text: #111827;
      --surface-1: #ffffff;
      --surface-2: #e6ebee;
      --border-soft: rgba(54, 69, 79, 0.24);
      --success: #1b4f55;
      --success-rgb: 27, 79, 85;
      --success-soft: rgba(27, 79, 85, 0.12);
      --info: #36454f;
      --info-rgb: 54, 69, 79;
      --info-soft: rgba(54, 69, 79, 0.12);
      --nav-text: #36454f;
      --nav-hover-bg: #e6ebee;
      --nav-hover-text: #111827;
      --header-bg: rgba(255, 255, 255, 0.86);
      --card-shadow: 0 10px 24px -18px rgba(15, 26, 41, 0.26);
      --sidebar-width: 17rem;
      --sidebar-width-collapsed: 5rem;
      --motion-fast: 180ms;
      --motion-base: 320ms;
      --motion-slow: 560ms;
      --ease-standard: cubic-bezier(0.2, 0.8, 0.2, 1);
      --ease-emphasis: cubic-bezier(0.16, 1, 0.3, 1);
      --tippy-bg: #0f172a;
      --tippy-fg: #f8fafc;
      --tippy-border: rgba(148, 163, 184, 0.3);
      --tippy-shadow: 0 12px 24px -16px rgba(2, 6, 23, 0.9);
    }
    html.dark {
      --primary: #1b4f55;
      --primary-rgb: 27, 79, 85;
      --primary-strong: #2f6e76;
      --primary-soft: rgba(27, 79, 85, 0.28);
      --app-bg: #0f1a29;
      --app-text: #e8eef2;
      --surface-1: #1a2b3d;
      --surface-2: #36454f;
      --border-soft: rgba(194, 201, 204, 0.34);
      --success: #46a0ab;
      --success-rgb: 70, 160, 171;
      --success-soft: rgba(70, 160, 171, 0.22);
      --info: #c2c9cc;
      --info-rgb: 194, 201, 204;
      --info-soft: rgba(194, 201, 204, 0.2);
      --nav-text: #c2c9cc;
      --nav-hover-bg: #1b4f55;
      --nav-hover-text: #f7f9fa;
      --header-bg: rgba(15, 26, 41, 0.84);
      --card-shadow: 0 12px 28px -18px rgba(0, 0, 0, 0.75);
      --tippy-bg: #f8fafc;
      --tippy-fg: #0f172a;
      --tippy-border: rgba(148, 163, 184, 0.55);
      --tippy-shadow: 0 14px 30px -20px rgba(148, 163, 184, 0.65);
    }
    
    body {
      background-color: var(--app-bg) !important;
      color: var(--app-text) !important;
      transition: background-color var(--motion-base) var(--ease-standard), color var(--motion-base) var(--ease-standard);
    }

    /* --- Global Theme Bridge (applies across HTML + JS-rendered sections) --- */
    .bg-white { background-color: var(--surface-1) !important; }
    .bg-slate-50 { background-color: color-mix(in srgb, var(--surface-1) 68%, var(--surface-2)) !important; }
    .bg-slate-100 { background-color: var(--surface-2) !important; }
    .text-slate-900 { color: color-mix(in srgb, var(--app-text) 92%, black) !important; }
    .text-slate-800 { color: var(--app-text) !important; }
    .text-slate-700 { color: color-mix(in srgb, var(--app-text) 84%, white) !important; }
    .text-slate-600 { color: color-mix(in srgb, var(--app-text) 72%, white) !important; }
    .text-slate-500 { color: color-mix(in srgb, var(--app-text) 55%, white) !important; }
    .text-slate-400 { color: color-mix(in srgb, var(--app-text) 42%, white) !important; }
    .border-slate-200 { border-color: var(--border-soft) !important; }
    .border-slate-100 { border-color: color-mix(in srgb, var(--border-soft) 70%, transparent) !important; }

    .dark .dark\:bg-slate-950 { background-color: var(--app-bg) !important; }
    .dark .dark\:bg-slate-900 { background-color: var(--surface-1) !important; }
    .dark .dark\:bg-slate-800 { background-color: var(--surface-2) !important; }
    .dark .dark\:bg-slate-700 { background-color: color-mix(in srgb, var(--surface-2) 80%, #4a5c67) !important; }
    .dark .dark\:bg-slate-900\/80 { background-color: color-mix(in srgb, var(--surface-1) 80%, transparent) !important; }
    .dark .dark\:bg-slate-950\/95 { background-color: color-mix(in srgb, var(--app-bg) 95%, transparent) !important; }
    .dark .dark\:text-slate-100 { color: var(--app-text) !important; }
    .dark .dark\:text-slate-200 { color: color-mix(in srgb, var(--app-text) 88%, #fff) !important; }
    .dark .dark\:text-slate-300 { color: color-mix(in srgb, var(--app-text) 76%, #fff) !important; }
    .dark .dark\:text-slate-400 { color: color-mix(in srgb, var(--app-text) 64%, #fff) !important; }
    .dark .dark\:border-slate-800 { border-color: var(--border-soft) !important; }
    .dark .dark\:border-slate-700 { border-color: color-mix(in srgb, var(--border-soft) 86%, #70828d) !important; }
    .dark .dark\:border-slate-600 { border-color: color-mix(in srgb, var(--border-soft) 78%, #8ea0a9) !important; }

    .bg-blue-600 { background-color: var(--primary) !important; }
    .hover\:bg-blue-700:hover { background-color: color-mix(in srgb, var(--primary) 82%, #10393f) !important; }
    .dark .dark\:bg-blue-600 { background-color: var(--primary) !important; }
    .dark .dark\:hover\:bg-blue-700:hover { background-color: color-mix(in srgb, var(--primary) 82%, #10393f) !important; }
    .bg-blue-500 { background-color: var(--primary) !important; }
    .text-blue-700 { color: var(--primary-strong) !important; }
    .text-blue-600 { color: var(--primary) !important; }
    .text-blue-500 { color: color-mix(in srgb, var(--primary) 88%, white) !important; }
    .dark .dark\:text-blue-400 { color: color-mix(in srgb, var(--primary) 38%, white) !important; }
    .dark .dark\:text-blue-500 { color: color-mix(in srgb, var(--primary) 46%, white) !important; }
    .bg-blue-50 { background-color: var(--primary-soft) !important; }
    .bg-blue-100 { background-color: color-mix(in srgb, var(--primary) 18%, var(--surface-1)) !important; }
    .border-blue-200 { border-color: color-mix(in srgb, var(--primary) 28%, var(--surface-1)) !important; }
    .border-blue-100 { border-color: color-mix(in srgb, var(--primary) 20%, var(--surface-1)) !important; }
    .hover\:bg-blue-50:hover { background-color: color-mix(in srgb, var(--primary-soft) 86%, var(--surface-1)) !important; }
    .hover\:bg-blue-100:hover { background-color: color-mix(in srgb, var(--primary) 22%, var(--surface-1)) !important; }
    .hover\:text-blue-600:hover { color: var(--primary) !important; }
    .hover\:text-blue-700:hover { color: var(--primary-strong) !important; }
    .group:hover .group-hover\:text-blue-500 { color: color-mix(in srgb, var(--primary) 90%, white) !important; }
    .group:hover .group-hover\:text-blue-600 { color: var(--primary) !important; }
    .group:hover .group-hover\:text-blue-700 { color: var(--primary-strong) !important; }
    .group:hover .group-hover\:bg-blue-100 { background-color: color-mix(in srgb, var(--primary) 22%, var(--surface-1)) !important; }
    .group:hover .group-hover\:bg-blue-600 { background-color: var(--primary) !important; }
    .focus\:ring-blue-500:focus { --tw-ring-color: color-mix(in srgb, var(--primary) 72%, white) !important; }
    .focus\:border-blue-500:focus { border-color: color-mix(in srgb, var(--primary) 72%, white) !important; }
    .focus-within\:ring-blue-500\/50:focus-within { --tw-ring-color: color-mix(in srgb, var(--primary) 52%, white) !important; }
    .focus-within\:border-blue-500:focus-within { border-color: color-mix(in srgb, var(--primary) 72%, white) !important; }
    .border-blue-500 { border-color: color-mix(in srgb, var(--primary) 75%, white) !important; }
    .hover\:border-blue-500:hover { border-color: color-mix(in srgb, var(--primary) 75%, white) !important; }
    .dark .dark\:bg-blue-900\/10 { background-color: color-mix(in srgb, var(--primary) 14%, transparent) !important; }
    .dark .dark\:bg-blue-900\/20 { background-color: color-mix(in srgb, var(--primary) 22%, transparent) !important; }
    .dark .dark\:bg-blue-900\/30 { background-color: color-mix(in srgb, var(--primary) 30%, transparent) !important; }
    .dark .dark\:bg-blue-900\/40 { background-color: color-mix(in srgb, var(--primary) 38%, transparent) !important; }
    .dark .dark\:bg-blue-900\/50 { background-color: color-mix(in srgb, var(--primary) 46%, transparent) !important; }
    .dark .dark\:border-blue-800 { border-color: color-mix(in srgb, var(--primary) 48%, #8ea0a9) !important; }
    .dark .dark\:hover\:bg-blue-900\/20:hover { background-color: color-mix(in srgb, var(--primary) 24%, transparent) !important; }
    .dark .dark\:hover\:bg-blue-900\/40:hover { background-color: color-mix(in srgb, var(--primary) 40%, transparent) !important; }
    .dark .group:hover .dark\:group-hover\:bg-blue-900\/20 { background-color: color-mix(in srgb, var(--primary) 24%, transparent) !important; }
    .dark .group:hover .dark\:group-hover\:text-blue-400 { color: color-mix(in srgb, var(--primary) 34%, white) !important; }

    .text-emerald-700 { color: var(--success) !important; }
    .text-emerald-600 { color: var(--success) !important; }
    .text-emerald-500 { color: color-mix(in srgb, var(--success) 88%, white) !important; }
    .bg-emerald-50 { background-color: var(--success-soft) !important; }
    .bg-emerald-100 { background-color: color-mix(in srgb, var(--success) 16%, var(--surface-1)) !important; }
    .border-emerald-200 { border-color: color-mix(in srgb, var(--success) 30%, var(--surface-1)) !important; }
    .border-emerald-100 { border-color: color-mix(in srgb, var(--success) 22%, var(--surface-1)) !important; }
    .hover\:bg-emerald-700:hover { background-color: color-mix(in srgb, var(--success) 82%, #0f3136) !important; }
    .hover\:text-emerald-600:hover { color: var(--success) !important; }
    .dark .dark\:text-emerald-400 { color: color-mix(in srgb, var(--success) 24%, white) !important; }
    .dark .dark\:text-emerald-300 { color: color-mix(in srgb, var(--success) 16%, white) !important; }
    .dark .dark\:bg-emerald-900\/10 { background-color: color-mix(in srgb, var(--success) 14%, transparent) !important; }
    .dark .dark\:bg-emerald-900\/20 { background-color: color-mix(in srgb, var(--success) 22%, transparent) !important; }
    .dark .dark\:bg-emerald-900\/30 { background-color: color-mix(in srgb, var(--success) 30%, transparent) !important; }
    .dark .dark\:bg-emerald-900\/40 { background-color: color-mix(in srgb, var(--success) 38%, transparent) !important; }
    .dark .dark\:border-emerald-800 { border-color: color-mix(in srgb, var(--success) 46%, #8ea0a9) !important; }

    .text-purple-700 { color: var(--info) !important; }
    .text-purple-600 { color: var(--info) !important; }
    .text-purple-500 { color: color-mix(in srgb, var(--info) 90%, white) !important; }
    .bg-purple-50 { background-color: var(--info-soft) !important; }
    .bg-purple-100 { background-color: color-mix(in srgb, var(--info) 14%, var(--surface-1)) !important; }
    .border-purple-200 { border-color: color-mix(in srgb, var(--info) 30%, var(--surface-1)) !important; }
    .hover\:text-purple-600:hover { color: var(--info) !important; }
    .dark .dark\:text-purple-400 { color: color-mix(in srgb, var(--info) 92%, white) !important; }
    .dark .dark\:bg-purple-900\/20 { background-color: color-mix(in srgb, var(--info) 20%, transparent) !important; }
    .dark .dark\:bg-purple-900\/30 { background-color: color-mix(in srgb, var(--info) 28%, transparent) !important; }

    /* Semantic tone utilities for JS-rendered templates */
    .tone-accent {
      background-color: var(--primary-soft) !important;
      color: var(--primary) !important;
      border-color: color-mix(in srgb, var(--primary) 28%, var(--surface-1)) !important;
    }
    .tone-success {
      background-color: var(--success-soft) !important;
      color: var(--success) !important;
      border-color: color-mix(in srgb, var(--success) 30%, var(--surface-1)) !important;
    }
    .tone-info {
      background-color: var(--info-soft) !important;
      color: var(--info) !important;
      border-color: color-mix(in srgb, var(--info) 30%, var(--surface-1)) !important;
    }
    .tone-warning {
      background-color: rgba(245, 158, 11, 0.14) !important;
      color: #b45309 !important;
      border-color: rgba(245, 158, 11, 0.28) !important;
    }
    .tone-danger {
      background-color: rgba(239, 68, 68, 0.12) !important;
      color: #b91c1c !important;
      border-color: rgba(239, 68, 68, 0.3) !important;
    }
    .tone-neutral {
      background-color: var(--surface-2) !important;
      color: color-mix(in srgb, var(--app-text) 78%, white) !important;
      border-color: var(--border-soft) !important;
    }
    .dark .tone-accent {
      background-color: color-mix(in srgb, var(--primary) 24%, transparent) !important;
      color: color-mix(in srgb, var(--primary) 90%, white) !important;
      border-color: color-mix(in srgb, var(--primary) 46%, #8ea0a9) !important;
    }
    .dark .tone-success {
      background-color: color-mix(in srgb, var(--success) 24%, transparent) !important;
      color: color-mix(in srgb, var(--success) 90%, white) !important;
      border-color: color-mix(in srgb, var(--success) 46%, #8ea0a9) !important;
    }
    .dark .tone-info {
      background-color: color-mix(in srgb, var(--info) 22%, transparent) !important;
      color: color-mix(in srgb, var(--info) 92%, white) !important;
      border-color: color-mix(in srgb, var(--info) 44%, #8ea0a9) !important;
    }
    .dark .tone-warning {
      background-color: rgba(245, 158, 11, 0.2) !important;
      color: #fcd34d !important;
      border-color: rgba(245, 158, 11, 0.45) !important;
    }
    .dark .tone-danger {
      background-color: rgba(239, 68, 68, 0.2) !important;
      color: #fca5a5 !important;
      border-color: rgba(239, 68, 68, 0.44) !important;
    }
    .dark .tone-neutral {
      background-color: color-mix(in srgb, var(--surface-2) 88%, transparent) !important;
      color: color-mix(in srgb, var(--app-text) 72%, white) !important;
      border-color: var(--border-soft) !important;
    }

    .action-link {
      color: var(--primary-strong) !important;
      font-weight: 700;
    }
    .action-link:hover {
      color: var(--primary) !important;
      text-decoration: underline;
      text-decoration-thickness: 2px;
      text-underline-offset: 2px;
    }
    .dark .action-link {
      color: color-mix(in srgb, var(--primary) 34%, white) !important;
    }
    .dark .action-link:hover {
      color: color-mix(in srgb, var(--primary) 24%, white) !important;
    }

    /* --- Sidebar Animation Logic --- */
    #sidebar { 
      transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); 
      width: var(--sidebar-width); 
      z-index: 50; 
      white-space: nowrap;
      background-color: var(--surface-1);
      border-right-color: var(--border-soft);
      box-shadow: 0 18px 34px -26px rgba(0, 0, 0, 0.45);
    }

    /* Fix for Profile Icon Centering */
    #sidebar.collapsed #userInfo {
      justify-content: center; /* Forces the content to the center */
      gap: 0 !important;       /* Removes the gap between image and hidden text */
    }
    
    /* Optional: Ensure the container padding doesn't interfere */
    #sidebar.collapsed .border-t.p-4 {
      padding-left: 0;
      padding-right: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    #sidebar.collapsed { width: var(--sidebar-width-collapsed); }

    /* Hide horizontal scrollbar that appears during shrink */
    #sidebar nav {
        overflow-x: hidden; 
    }
    #sidebar.collapsed nav::-webkit-scrollbar {
        display: none; /* Clean look when collapsed */
    }
    
    /* --- Top Logo Centering --- */
    .sidebar-header {
        transition: padding 0.3s ease, justify-content 0.3s ease;
        padding-left: 1.5rem; /* px-6 equivalent */
        padding-right: 1.5rem;
    }
    
    /* When collapsed: Remove padding and Center the logo content */
    #sidebar.collapsed .sidebar-header {
        padding-left: 0;
        padding-right: 0;
        justify-content: center;
    }

    .sidebar-header {
      border-color: var(--border-soft) !important;
    }
    .sidebar-header:hover {
      background: color-mix(in srgb, var(--surface-2) 70%, transparent) !important;
    }

    /* --- Smooth Text Hiding --- */
    .sidebar-label { 
      opacity: 1;
      width: auto;
      margin-left: 0.75rem; 
      transition: opacity 0.2s ease, width 0.3s ease, margin 0.3s ease;
      display: block;
    }
    
    .group-heading {
        opacity: 1;
        transition: opacity 0.2s ease;
        white-space: nowrap;
        padding-left: 0.75rem; /* Align with links */
    }

    /* Collapse State: Text */
    #sidebar.collapsed .sidebar-label { 
      opacity: 0; 
      width: 0;
      margin-left: 0; 
      pointer-events: none;
      overflow: hidden; 
    }
    
    #sidebar.collapsed .group-heading {
        opacity: 0;
        pointer-events: none;
    }

    /* Collapse State: Dark Mode Toggle - HIDDEN AS REQUESTED */
    #sidebar.collapsed #darkModeToggle {
      display: none !important;
    }
    
    /* --- Nav Icons Centering --- */
    .nav-link { 
      display: flex; 
      align-items: center; 
      border-radius: 0.75rem; 
      transition: transform var(--motion-fast) var(--ease-standard), color var(--motion-fast) var(--ease-standard), background-color var(--motion-fast) var(--ease-standard), box-shadow var(--motion-fast) var(--ease-standard);
      font-weight: 500; 
      margin-bottom: 0.25rem; 
      color: var(--nav-text); 
      position: relative;
      overflow: hidden;
      z-index: 1;
      
      /* Standard Padding */
      padding: 0.75rem 0.75rem 0.75rem 1.5rem; /* top right bottom left */
    }

    .nav-link::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(90deg, rgba(var(--primary-rgb), 0.24), rgba(194, 201, 204, 0.18));
      opacity: 0;
      transform: scale(0.95);
      transition: opacity var(--motion-fast) var(--ease-standard), transform var(--motion-base) var(--ease-emphasis);
      z-index: -1;
    }
    
    /* When Collapsed: Perfect Center */
    #sidebar.collapsed .nav-link { 
        padding-left: 0;
        padding-right: 0;
        justify-content: center; /* Flex center usually works best here */
    }
    
    #sidebar.collapsed .nav-icon { margin-right: 0; }

    /* Hover States */
    .nav-link:hover { 
      background-color: var(--nav-hover-bg); 
      color: var(--nav-hover-text); 
      transform: translateX(3px);
    }

    .nav-link.active { 
      color: var(--primary-strong);
      font-weight: 700;
      background-color: color-mix(in srgb, var(--primary) 22%, var(--surface-1));
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--primary) 45%, var(--surface-1));
    }
    .nav-link.active::before {
      opacity: 0;
      transform: none;
      background: none;
    }
    .nav-link.active::after {
      content: "";
      position: absolute;
      left: 0.3rem;
      top: 50%;
      transform: translateY(-50%);
      width: 0.22rem;
      height: 1.45rem;
      border-radius: 999px;
      background: var(--primary);
      box-shadow: 0 0 0 1px color-mix(in srgb, var(--primary) 66%, transparent);
      opacity: 1;
    }
    .dark .nav-link.active {
      color: var(--nav-hover-text);
      background-color: color-mix(in srgb, var(--primary) 56%, var(--surface-2));
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--primary) 74%, #9fb0b8);
      text-shadow: none;
    }
    .dark .nav-link.active::before {
      opacity: 0;
      background: none;
    }
    .dark .nav-link.active::after {
      background: color-mix(in srgb, var(--primary) 26%, white);
      box-shadow: 0 0 0 1px color-mix(in srgb, var(--primary) 34%, white);
    }
    .dark .nav-link.active .nav-icon {
      color: var(--nav-hover-text);
      filter: none;
    }
    .nav-link.active:hover {
      transform: none;
    }
    #sidebar.collapsed .nav-link.active {
      justify-content: center;
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--primary) 62%, var(--surface-1));
    }
    #sidebar.collapsed .nav-link.active::after {
      left: 50%;
      top: auto;
      bottom: 0.35rem;
      transform: translateX(-50%);
      width: 1.4rem;
      height: 0.2rem;
    }

    .nav-icon { width: 20px; height: 20px; flex-shrink: 0; transition: all 0.3s ease; }

    .nav-link.active .nav-icon {
      transform: scale(1.08);
    }

    .premium-header {
      transition: backdrop-filter var(--motion-base) var(--ease-standard), background-color var(--motion-base) var(--ease-standard), box-shadow var(--motion-base) var(--ease-standard), border-color var(--motion-base) var(--ease-standard);
      background: var(--header-bg) !important;
      border-color: var(--border-soft) !important;
    }
    .premium-header.is-scrolled {
      background: color-mix(in srgb, var(--surface-1) 88%, transparent);
      box-shadow: 0 14px 30px -24px rgba(15, 26, 41, 0.45);
      border-color: var(--border-soft);
    }
    .dark .premium-header.is-scrolled {
      background: color-mix(in srgb, var(--surface-1) 90%, transparent);
      box-shadow: 0 16px 30px -24px rgba(0, 0, 0, 0.75);
      border-color: var(--border-soft);
    }

    #activeSectionLabel {
      transition: opacity var(--motion-fast) var(--ease-standard), transform var(--motion-fast) var(--ease-emphasis);
      transform-origin: left center;
    }
    #activeSectionLabel.is-swapping {
      opacity: 0;
      transform: translateY(5px) scale(0.98);
    }

    .reveal-item {
      opacity: 0;
      transform: translateY(20px) scale(0.98);
      transition: opacity var(--motion-slow) var(--ease-emphasis), transform var(--motion-slow) var(--ease-emphasis);
      transition-delay: var(--reveal-delay, 0ms);
      will-change: transform, opacity;
    }
    .reveal-item.is-revealed {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .parallax-blob {
      transform: translate3d(0, calc(var(--parallax-shift, 0px) * var(--parallax-depth, 1)), 0);
      transition: transform 100ms linear;
      will-change: transform;
    }

    .premium-card {
      border: 1px solid var(--border-soft);
      box-shadow: var(--card-shadow);
      transition: transform var(--motion-base) var(--ease-emphasis), box-shadow var(--motion-base) var(--ease-emphasis), border-color var(--motion-fast) var(--ease-standard);
    }
    .premium-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 22px 42px -28px rgba(15, 26, 41, 0.55);
      border-color: rgba(var(--primary-rgb), 0.38);
    }
    .dark .premium-card {
      border-color: var(--border-soft);
      box-shadow: var(--card-shadow);
    }

    .kpi-card {
      position: relative;
      isolation: isolate;
    }
    .kpi-card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(120deg, rgba(37,99,235,0.45), rgba(16,185,129,0.35), rgba(249,115,22,0.45), rgba(37,99,235,0.45));
      background-size: 300% 300%;
      animation: kpi-gradient 8s linear infinite;
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      z-index: -1;
      opacity: 0.9;
    }
    .dark .kpi-card::before {
      opacity: 0.65;
    }

    @keyframes kpi-gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .magnetic-btn {
      transition: transform var(--motion-fast) var(--ease-emphasis), box-shadow var(--motion-fast) var(--ease-standard), background-color var(--motion-fast) var(--ease-standard);
      will-change: transform;
    }
    .magnetic-btn:hover {
      box-shadow: 0 12px 28px -18px rgba(37, 99, 235, 0.9);
    }

    /* Main Content Slide */
    main { transition: padding-left 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
    #mainContent {
      background-color: var(--app-bg) !important;
      color: var(--app-text);
    }

    /* Helpers */
    /* Improved Page Transitions */
.page-section { 
  display: none; 
  opacity: 0; 
  transform: scale(0.985); /* Universal center fade in */
  transform-origin: center center;
  filter: blur(2px);
  transition: opacity 0.42s cubic-bezier(0.16, 1, 0.3, 1), transform 0.42s cubic-bezier(0.16, 1, 0.3, 1), filter 0.42s cubic-bezier(0.16, 1, 0.3, 1);
}

.page-section.show { 
  opacity: 1; 
  transform: scale(1); 
  filter: blur(0);
}
    .glass { background: color-mix(in srgb, var(--surface-1) 90%, transparent); backdrop-filter: blur(10px); border: 1px solid var(--border-soft); }
    .dark .glass { background: color-mix(in srgb, var(--surface-1) 88%, transparent); border: 1px solid var(--border-soft); }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }

    @media (max-width: 768px) {
      #sidebar { position: fixed; transform: translateX(-100%); }
      #sidebar.open { transform: translateX(0); }
    }

    /* --- ANIMATIONS (Blobs, Splash) --- */
    @keyframes blob {
      0% { transform: translate(0px, 0px) scale(1); }
      33% { transform: translate(30px, -50px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
      100% { transform: translate(0px, 0px) scale(1); }
    }
    .animate-blob { animation: blob 7s infinite; }
    .animation-delay-2000 { animation-delay: 2s; }
    .animation-delay-4000 { animation-delay: 4s; }
    
    /* Splash Screen Animations */
    @keyframes breath {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .animate-breath { animation: breath 3s ease-in-out infinite; }

    @keyframes progress {
      0% { transform: translateX(-100%); }
      50% { transform: translateX(0%); }
      100% { transform: translateX(100%); }
    }
    .animate-progress { animation: progress 1.5s ease-in-out infinite; }

    .loader-hidden { opacity: 0; pointer-events: none; }

   /* --- Brand Modal Animations --- */
    /* ENTRY */
    @keyframes brand-spin-up {
      0% { transform: scale(0) rotate(-540deg); opacity: 0; }
      60% { transform: scale(1.1) rotate(10deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes brand-text-reveal {
      0% { transform: translateY(20px); opacity: 0; filter: blur(10px); }
      100% { transform: translateY(0); opacity: 1; filter: blur(0); }
    }

    /* EXIT */
    @keyframes brand-spin-down {
      0% { transform: scale(1) rotate(0deg); opacity: 1; }
      100% { transform: scale(0) rotate(540deg); opacity: 0; }
    }
    @keyframes brand-text-hide {
      0% { transform: translateY(0); opacity: 1; filter: blur(0); }
      100% { transform: translateY(20px); opacity: 0; filter: blur(10px); }
    }

    /* CLASSES */
    .animate-brand-logo { animation: brand-spin-up 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
    .animate-brand-text { animation: brand-text-reveal 0.8s ease-out 0.3s forwards; }
    .animate-brand-logo-out { animation: brand-spin-down 0.5s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards; }
    .animate-brand-text-out { animation: brand-text-hide 0.3s ease-in forwards; }
    .opacity-0 { opacity: 0; }

    /* --- NEW LOGIN PAGE STYLES --- */
    .login-split-screen {
      display: grid;
      grid-template-columns: 1fr;
      min-height: 100vh;
      width: 100vw;
    }
    @media (min-width: 1024px) {
      .login-split-screen { grid-template-columns: 1.2fr 1fr; }
    }

    /* The Dark Pattern Background */
    .pattern-grid {
      background-size: 50px 50px;
      background-image: 
        linear-gradient(to right, rgba(255,255,255,0.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,0.05) 1px, transparent 1px);
      mask-image: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), black 0%, transparent 50%);
      -webkit-mask-image: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), black 0%, transparent 60%);
    }
    
    /* Floating Animation for the 'Stat Card' */
    @keyframes float-y {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
    }
    .animate-float { animation: float-y 6s ease-in-out infinite; }

    /* Text Rotator */
    .scroller { height: 1.2em; line-height: 1.2em; position: relative; overflow: hidden; display: inline-block; vertical-align: bottom; }
    .scroller span { display: block; animation: spin-text 6s infinite; }
    @keyframes spin-text {
      0%, 15% { transform: translateY(0); }
      33%, 48% { transform: translateY(-100%); }
      66%, 81% { transform: translateY(-200%); }
      100% { transform: translateY(-300%); } 
    }
/* Tippy Theme (auto-switches with app theme) */
.tippy-box[data-theme~='flowr'] {
  background-color: #0f172a !important;
  color: #f8fafc !important;
  font-weight: 600;
  font-size: 12px;
  border-radius: 8px;
  padding: 2px 6px;
  border: 1px solid rgba(148, 163, 184, 0.3) !important;
  box-shadow: 0 12px 24px -16px rgba(2, 6, 23, 0.9) !important;
  filter: none !important;
  backdrop-filter: none !important;
  opacity: 1 !important;
}

.tippy-box[data-theme~='flowr'] > .tippy-arrow:before {
  color: #0f172a !important;
}

.dark .tippy-box[data-theme~='flowr'] {
  background-color: #ffffff !important;
  color: #0f172a !important;
  font-weight: 600;
  font-size: 12px;
  border-radius: 8px;
  padding: 2px 6px;
  border: 1px solid rgba(148, 163, 184, 0.8) !important;
  box-shadow: 0 16px 32px -22px rgba(15, 23, 42, 0.55) !important;
  filter: none !important;
  backdrop-filter: none !important;
  opacity: 1 !important;
}

.dark .tippy-box[data-theme~='flowr'] > .tippy-arrow:before {
  color: #ffffff !important;
}

.tippy-content {
  filter: none !important;
  text-shadow: none !important;
}

.command-dialog {
  transition: opacity var(--motion-base) var(--ease-standard), transform var(--motion-base) var(--ease-emphasis);
}
.command-item {
  transition: background-color var(--motion-fast) var(--ease-standard), transform var(--motion-fast) var(--ease-standard), border-color var(--motion-fast) var(--ease-standard);
}
.command-item:hover,
.command-item.active {
  background-color: rgba(37, 99, 235, 0.08);
  border-color: rgba(37, 99, 235, 0.28);
  transform: translateY(-1px);
}
.dark .command-item:hover,
.dark .command-item.active {
  background-color: rgba(37, 99, 235, 0.18);
  border-color: rgba(96, 165, 250, 0.4);
}

.section-skeleton {
  animation: skeleton-pulse 1.3s ease-in-out infinite;
  background: linear-gradient(90deg, rgba(226,232,240,0.75) 25%, rgba(241,245,249,0.95) 50%, rgba(226,232,240,0.75) 75%);
  background-size: 200% 100%;
}
.dark .section-skeleton {
  background: linear-gradient(90deg, rgba(51,65,85,0.7) 25%, rgba(71,85,105,0.92) 50%, rgba(51,65,85,0.7) 75%);
  background-size: 200% 100%;
}
@keyframes skeleton-pulse {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
  .reveal-item {
    opacity: 1 !important;
    transform: none !important;
  }
}

  </style>

  <audio id="successSound" src="assets/ding.wav" preload="auto"></audio>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-100 antialiased">

  <div id="brandModal" class="fixed inset-0 z-[200] hidden flex-col items-center justify-center cursor-pointer transition-all duration-500">
    <div id="brandBackdrop" class="absolute inset-0 bg-slate-50/90 dark:bg-slate-950/95 backdrop-blur-xl transition-opacity duration-500 opacity-0"></div>
    
    <div class="relative z-10 flex flex-col items-center text-center p-8">
      
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-blue-500/30 rounded-full blur-3xl animate-pulse"></div>
      
      <div id="brandModalLogo" class="relative w-80 h-80 mb-10 rounded-full shadow-2xl ring-8 ring-white dark:ring-slate-800 bg-white flex items-center justify-center overflow-hidden">
        <img src="assets/Flowr Logo Big.png" alt="Flowr" class="w-full h-full object-cover" />
      </div>

      <div id="brandModalText" class="relative opacity-0">
        <h2 class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-white tracking-[0.2em] uppercase mb-2">Pastry Management</h2>
        <div class="flex items-center justify-center gap-3 text-slate-400 text-sm font-mono mt-4">
            <span>v1.0.0</span>
            <span class="w-1 h-1 rounded-full bg-slate-400"></span>
            <span>Lush Patisserie</span>
        </div>
      </div>

    </div>
  </div>

  <div id="globalLoader" class="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-slate-50/90 dark:bg-slate-950/90 backdrop-blur-3xl transition-opacity duration-700 ease-out">
    
    <div class="absolute top-1/3 left-1/4 w-96 h-96 bg-blue-400/30 rounded-full mix-blend-multiply filter blur-3xl animate-blob"></div>
    <div class="absolute top-1/3 right-1/4 w-96 h-96 bg-purple-400/30 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-2000"></div>

    <div class="relative flex flex-col items-center">
      <div class="relative mb-6">
        <div class="absolute inset-0 bg-blue-500 rounded-full blur-xl opacity-20 animate-pulse"></div>
        <img src="assets/Flowr Logo Big.png" alt="Loading..." class="relative h-24 w-24 rounded-full shadow-2xl animate-breath" />
      </div>

      <h1 class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight mb-2">flowr</h1>
      
      <div class="h-1 w-32 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden">
        <div class="h-full bg-blue-600 rounded-full animate-progress"></div>
      </div>
    </div>
  </div>

  <div id="signInPage" class="fixed inset-0 z-[100] bg-white dark:bg-slate-950 overflow-hidden" style="display:none;">
    
    <div class="login-split-screen">
      
      <div id="loginVisuals" class="relative hidden lg:flex flex-col justify-between bg-slate-900 text-white p-12 overflow-hidden">
        
        <div class="absolute inset-0 z-0">
           <div class="absolute inset-0 pattern-grid z-10 pointer-events-none"></div>
           
           <div class="absolute top-[-20%] left-[-10%] w-[500px] h-[500px] bg-blue-600/30 rounded-full blur-[100px] animate-blob"></div>
           <div class="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-purple-600/20 rounded-full blur-[100px] animate-blob animation-delay-4000"></div>
        </div>

        <div class="relative z-20">
          <div class="flex items-center gap-3 mb-8">
            <img src="assets/Flowr Logo Big.png" class="w-10 h-10 rounded-full bg-white/10 backdrop-blur" alt="Logo">
            <span class="font-bold tracking-widest uppercase text-sm opacity-70">Lush Patisserie</span>
          </div>
          
          <h1 class="text-5xl font-extrabold tracking-tight leading-tight mb-6">
            Built for cloud kitchens<br />
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">
              <div class="scroller text-left">
                <span>Production</span>
                <span>Inventory</span>
                <span>Costing</span>
                <span>Production</span>
              </div>
            </span>
          </h1>
          <p class="text-slate-400 text-lg max-w-md leading-relaxed">
            The all-in-one operating system for high-volume pastry kitchens. Precision down to the gram.
          </p>
        </div>

        <div class="relative z-20 self-center w-full max-w-md animate-float">
          <div class="glass border border-white/10 bg-white/5 p-6 rounded-2xl backdrop-blur-md shadow-2xl">
             <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center">
                    <i data-feather="trending-up"></i>
                  </div>
                  <div>
                    <p class="text-sm font-bold text-white">Revenue</p>
                    <p class="text-xs text-slate-400">+25% this month</p>
                  </div>
                </div>
                <span class="px-2 py-1 rounded bg-green-500/10 text-green-400 text-xs font-bold">On Track</span>
             </div>
             <div class="space-y-2">
               <div class="h-2 w-full bg-white/10 rounded-full overflow-hidden">
                 <div class="h-full w-3/4 bg-gradient-to-r from-green-400 to-blue-500"></div>
               </div>
               <div class="flex justify-between text-xs text-slate-400">
                 <span>Weekly Goal</span>
                 <span>75%</span>
               </div>
             </div>
          </div>
          <div class="absolute -z-10 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-[120%] bg-blue-500/20 blur-3xl rounded-full"></div>
        </div>

        <div class="relative z-20 text-xs text-slate-500 font-mono">
          Â© 2026 Flowr Systems. v1.0.0
        </div>
      </div>

      <div class="relative flex flex-col justify-center items-center p-8 bg-white dark:bg-slate-950">
        <div class="absolute lg:hidden top-0 left-0 w-full h-64 bg-gradient-to-b from-blue-500/10 to-transparent"></div>
        
        <div class="w-full max-w-sm space-y-8 relative z-10">
          
          <div class="text-center lg:text-left">
            <img src="assets/Flowr Logo Big.png" alt="Logo" class="w-16 h-16 rounded-2xl shadow-xl mx-auto lg:mx-0 mb-6 lg:hidden" />
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">Welcome back</h2>
            <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Please enter your details to sign in.</p>
          </div>

          <div class="space-y-4">
             <button id="signInGoogleBtn" class="w-full group relative flex items-center justify-center gap-3 bg-white dark:bg-slate-800 text-slate-700 dark:text-white px-6 py-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-all duration-200 shadow-sm hover:shadow-md">
              <svg class="w-5 h-5" viewBox="0 0 24 24">
                  <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                  <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                  <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                  <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
              </svg>
              <span class="font-semibold">Sign in with Google</span>
              <div class="absolute inset-0 rounded-xl ring-2 ring-blue-500/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            </button>
            
            <div class="relative">
              <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200 dark:border-slate-800"></div></div>
              <div class="relative flex justify-center text-xs uppercase"><span class="bg-white dark:bg-slate-950 px-2 text-slate-400">Authorized Personnel Only</span></div>
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Email address</label>
                <input type="email" disabled placeholder="chef@lushpatisserie.com" class="w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-slate-500 cursor-not-allowed opacity-60">
             </div>
          </div>

          <p class="text-center text-xs text-slate-400 mt-8">
            By signing in, you agree to our Terms of Service and Privacy Policy.
          </p>
        </div>
      </div>

    </div>
  </div>

  <aside id="sidebar" class="bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 h-screen fixed left-0 top-0 flex flex-col overflow-hidden shadow-sm z-50">
    <div onclick="openBrandModal()" class="sidebar-header flex items-center h-20 border-b border-slate-100 dark:border-slate-800 shrink-0 transition-colors cursor-pointer group hover:bg-slate-50 dark:hover:bg-slate-800/50">
      <img src="assets/Flowr Logo Big.png" alt="Logo" class="h-9 w-9 rounded-full bg-slate-100 object-cover shrink-0 ring-2 ring-white dark:ring-slate-700 group-hover:scale-110 transition-transform duration-300" />
      <div class="sidebar-label ml-3 overflow-hidden">
        <h2 class="text-sm font-bold text-slate-800 dark:text-white group-hover:text-blue-600 transition-colors">flowr</h2>
        <p class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500 tracking-wider">Pastry Management</p>
      </div>
      <button id="closeSidebarMobile" class="ml-auto md:hidden text-slate-400 dark:text-slate-500"><i data-feather="x"></i></button>
    </div>

    <nav class="flex-1 px-3 py-6 space-y-1 overflow-y-auto custom-scrollbar">
      <a href="#home" class="nav-link group" data-tooltip="Home">
        <i data-feather="home" class="nav-icon"></i>
        <span class="sidebar-label text-sm">Home</span>
      </a>
      <div class="group-heading px-3 mb-2 mt-4 text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">Operations</div>
      <a href="#workLog" class="nav-link group" data-tooltip="Work Log">
        <i data-feather="edit-3" class="nav-icon"></i>
        <span class="sidebar-label text-sm">Work Log</span>
      </a>
      <a href="#dashboard" class="nav-link group" data-tooltip="Dashboard">
        <i data-feather="pie-chart" class="nav-icon"></i>
        <span class="sidebar-label text-sm">Dashboard</span>
      </a>
      <a href="#recipeCalculator" class="nav-link group" data-tooltip="Recipe Calculator">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path>
        </svg>
        <span class="sidebar-label text-sm">Recipe Calculator</span>
      </a>
      <a href="#invoice" class="nav-link group" data-tooltip="Invoice">
        <i data-feather="file-text" class="nav-icon"></i>
        <span class="sidebar-label text-sm">Invoice</span>
      </a>
      <a href="#payments" class="nav-link group" data-tooltip="Payments">
  <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M6 3h12"></path>
    <path d="M6 8h12"></path>
    <path d="M6 13l8.5 10"></path>
    <path d="M6 13h3"></path>
    <path d="M9 13c6.627 0 12-5.373 12-12"></path>
  </svg>
  <span class="sidebar-label text-sm">Payments</span>
</a>
      <a href="#orders" class="nav-link group" data-tooltip="Orders">
        <i data-feather="shopping-bag" class="nav-icon"></i>
        <span class="sidebar-label text-sm">Orders</span>
      </a>
      <a href="#eventsStall" class="nav-link group" data-tooltip="Events & Stalls">
  <i data-feather="map-pin" class="nav-icon"></i>
  <span class="sidebar-label text-sm">Events & Stalls</span>
</a>
      <div class="my-4 border-t border-slate-100 dark:border-slate-800"></div>
      <div class="group-heading px-3 mb-2 text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">Management</div>
      <a href="#inventory" class="nav-link group" data-tooltip="Inventory">
        <i data-feather="package" class="nav-icon"></i>
        <span class="sidebar-label text-sm">Inventory</span>
      </a>
      <a href="#clients" class="nav-link group" data-tooltip="Clients">
        <i data-feather="users" class="nav-icon"></i>
        <span class="sidebar-label text-sm">Clients</span>
      </a>
      <a href="#fixedExpenses" class="nav-link group" data-tooltip="Fixed Expenses">
  <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 6c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
    <path d="M21 6v4c0 1.66-4 3-9 3s-9-1.34-9-3V6"></path>
    <path d="M21 10v4c0 1.66-4 3-9 3s-9-1.34-9-3v-4"></path>
    <path d="M21 14v4c0 1.66-4 3-9 3s-9-1.34-9-3v-4"></path>
  </svg>
  <span class="sidebar-label text-sm">Fixed Expenses</span>
</a>
      <a href="#export" class="nav-link group" data-tooltip="Export">
        <i data-feather="upload-cloud" class="nav-icon"></i>
        <span class="sidebar-label text-sm">Export</span>
      </a>
    </nav>

    <div class="border-t border-slate-100 dark:border-slate-800 p-4">
      <div id="userInfo" class="flex items-center gap-3 mb-4 hidden">
        <img id="userPhoto" class="h-8 w-8 rounded-full bg-slate-200 dark:bg-slate-700" src="" />
        <div class="sidebar-label overflow-hidden">
          <p id="userName" class="text-sm font-semibold text-slate-700 dark:text-slate-200 truncate">User</p>
          <p class="text-xs text-slate-400 font-medium">View Profile</p>
        </div>
      </div>
      
      <div class="flex gap-2">
        <button id="toggleSidebarBtn" class="hidden md:flex flex-1 items-center justify-center p-2 rounded-lg bg-slate-50 dark:bg-slate-800 text-slate-400 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 hover:text-slate-700 dark:hover:text-slate-200 transition-colors">
          <i data-feather="chevron-left" id="toggleIcon"></i>
        </button>
        
        <button id="darkModeToggle" class="flex items-center justify-center p-2 rounded-lg bg-slate-50 dark:bg-slate-800 text-slate-400 dark:text-yellow-400 hover:bg-slate-200 dark:hover:bg-slate-700 hover:text-slate-700 transition-colors" title="Toggle Dark Mode">
          <i data-feather="moon" id="themeIcon"></i>
        </button>
      </div>
    </div>
  </aside>

  <div id="sidebarOverlay" class="fixed inset-0 bg-slate-900/50 z-40 hidden md:hidden glass"></div>

  <main id="mainContent" class="md:pl-[17rem] min-h-screen flex flex-col bg-slate-50 dark:bg-slate-950 transition-all duration-300">
    <header id="topHeader" class="premium-header h-16 flex items-center justify-between px-6 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md sticky top-0 z-30 border-b border-slate-200/60 dark:border-slate-800/60">
      <div class="flex items-center gap-4">
        <button id="sidebarToggleMobile" class="md:hidden p-2 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-feather="menu"></i></button>
        <p id="activeSectionLabel" class="text-sm font-semibold text-slate-600 dark:text-slate-300">Home</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="commandPaletteTriggerMobile" type="button" class="md:hidden inline-flex items-center gap-2 px-2.5 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-xs font-semibold text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:bg-white dark:hover:bg-slate-700 transition-colors">
          <i data-feather="search" class="w-3.5 h-3.5"></i>
        </button>
        <button id="loginBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm">Sign In</button>
      </div>
      <div class="absolute left-0 bottom-0 h-[2px] w-full bg-slate-200/70 dark:bg-slate-800/70">
        <div id="sectionProgress" class="h-full w-0 bg-gradient-to-r from-blue-500 via-cyan-500 to-emerald-500 transition-all duration-500 ease-out"></div>
      </div>
    </header>

    <div class="p-4 md:p-8 w-full mx-auto text-slate-800 dark:text-slate-200">
      
     <div id="home" class="page-section">
  
  <div class="relative overflow-hidden rounded-3xl bg-slate-900 text-white p-8 mb-6 shadow-2xl premium-card reveal-item" data-reveal style="--reveal-delay:40ms;">
    <div class="parallax-blob absolute top-0 right-0 w-64 h-64 bg-indigo-600 opacity-20 rounded-full blur-3xl -mt-10 -mr-10" data-parallax data-depth="0.15"></div>
    <div class="parallax-blob absolute bottom-0 left-0 w-64 h-64 bg-blue-600 opacity-20 rounded-full blur-3xl -mb-10 -ml-10" data-parallax data-depth="0.25"></div>
    
    <div class="relative z-10 flex flex-col md:flex-row justify-between items-end gap-4">
      <div>
        <div class="flex items-center gap-2 mb-2">
           <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
           <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Lush Patisserie Madras</p>
        </div>
        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">
          <span id="heroGreeting">Hello</span>, <span id="heroName">Chef</span>
        </h1>
        <p class="text-slate-400 mt-2 text-sm">Your daily production command center.</p>
        <button id="heroCommandTrigger" type="button" class="hidden md:inline-flex mt-5 w-full max-w-lg items-center justify-between gap-3 px-4 py-3 rounded-xl border border-white/20 bg-white/10 text-slate-100 hover:bg-white/15 hover:border-white/30 transition-all backdrop-blur-sm">
          <span class="inline-flex items-center gap-3 text-sm font-semibold">
            <i data-feather="search" class="w-4 h-4"></i>
            Search anything...
          </span>
          <span class="text-[10px] px-2 py-1 rounded-md border border-white/25 text-slate-200/90">Ctrl/Cmd+K</span>
        </button>
      </div>
      
      <div class="hidden md:block text-right">
        <span class="text-3xl font-bold text-white/90" id="currentDateDisplay">Today</span>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

    <div onclick="showSection('workLog')" class="col-span-1 md:col-span-2 row-span-2 relative group cursor-pointer bg-gradient-to-br from-orange-500 to-rose-600 rounded-3xl p-8 text-white shadow-xl overflow-hidden transition-all hover:shadow-orange-500/25 hover:-translate-y-1 premium-card reveal-item" data-reveal style="--reveal-delay:80ms;">
      <div class="absolute -right-6 -bottom-6 text-white/10 group-hover:text-white/20 transition-all duration-500 transform group-hover:scale-110 group-hover:-rotate-12">
        <i data-feather="edit-3" style="width: 180px; height: 180px; stroke-width: 1;"></i>
      </div>
      
      <div class="relative z-10 h-full flex flex-col justify-between">
        <div>
          <div class="w-12 h-12 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center mb-6 border border-white/10">
             <i data-feather="clipboard" class="text-white w-6 h-6"></i>
          </div>
          <h2 class="text-3xl font-bold mb-2">Daily Log</h2>
          <p class="text-orange-50 text-base max-w-xs leading-relaxed font-medium">Track production batches, staff shifts, and daily kitchen output.</p>
        </div>
        <div class="mt-8 flex items-center gap-2 text-sm font-bold uppercase tracking-wider opacity-90 group-hover:gap-4 transition-all">
          <span>Start Log</span> <i data-feather="arrow-right" class="w-4 h-4"></i>
        </div>
      </div>
    </div>

    <div onclick="showSection('dashboard')" class="bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-800 hover:border-purple-400 dark:hover:border-purple-500 transition-all cursor-pointer group hover:-translate-y-1 premium-card kpi-card reveal-item" data-reveal style="--reveal-delay:140ms;">
      <div class="flex items-center justify-between mb-4">
        <div class="w-10 h-10 bg-purple-50 dark:bg-purple-900/20 rounded-xl flex items-center justify-center text-purple-600 dark:text-purple-400">
          <i data-feather="pie-chart"></i>
        </div>
        <span class="text-xs font-bold text-slate-300 group-hover:text-purple-500 transition-colors">STATS</span>
      </div>
      <h3 class="text-lg font-bold text-slate-800 dark:text-white">Analytics</h3>
      <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Performance & Trends.</p>
    </div>

    <div onclick="showSection('invoice')" class="bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-800 hover:border-emerald-400 dark:hover:border-emerald-500 transition-all cursor-pointer group hover:-translate-y-1 premium-card kpi-card reveal-item" data-reveal style="--reveal-delay:190ms;">
       <div class="flex items-center justify-between mb-4">
        <div class="w-10 h-10 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl flex items-center justify-center text-emerald-600 dark:text-emerald-400">
          <i data-feather="file-text"></i>
        </div>
        <span class="text-xs font-bold text-slate-300 group-hover:text-emerald-500 transition-colors">BILLING</span>
      </div>
      <h3 class="text-lg font-bold text-slate-800 dark:text-white">Invoice</h3>
      <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Generate Client Bills.</p>
    </div>

    <div onclick="showSection('recipeCalculator')" class="col-span-1 md:col-span-2 bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-800 hover:border-blue-400 dark:hover:border-blue-500 transition-all cursor-pointer group hover:-translate-y-1 flex items-center justify-between relative overflow-hidden premium-card reveal-item" data-reveal style="--reveal-delay:230ms;">
      <div class="absolute -right-10 -top-10 w-32 h-32 bg-blue-50 dark:bg-blue-900/10 rounded-full blur-2xl group-hover:bg-blue-100 dark:group-hover:bg-blue-900/20 transition-colors"></div>
      
      <div class="relative z-10">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-8 h-8 bg-blue-50 dark:bg-blue-900/20 rounded-lg flex items-center justify-center text-blue-600 dark:text-blue-400">
             <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path>
              </svg>
          </div>
          <h3 class="text-lg font-bold text-slate-800 dark:text-white">Recipe Calculator</h3>
        </div>
        <p class="text-sm text-slate-500 dark:text-slate-400">Calculate ingredients & margins.</p>
      </div>
      
      <div class="relative z-10 w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center text-slate-400 group-hover:bg-blue-600 group-hover:text-white transition-all">
        <i data-feather="chevron-right" class="w-4 h-4"></i>
      </div>
    </div>

  </div>

  <div class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-800 reveal-item" data-reveal style="--reveal-delay:260ms;">
    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Quick Actions</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      
      <button onclick="showSection('inventory')" class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800 hover:bg-white dark:hover:bg-slate-700 border border-transparent hover:border-slate-200 dark:hover:border-slate-600 transition-all text-left group premium-card">
  <div class="w-8 h-8 rounded-lg bg-white dark:bg-slate-900 flex items-center justify-center text-slate-500 group-hover:text-blue-500 transition-colors shadow-sm">
    <i data-feather="package" class="w-4 h-4"></i>
  </div>
  <span class="text-xs font-semibold text-slate-600 dark:text-slate-300">Add Ingredient</span>
</button>

      <button onclick="showSection('clients')" class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800 hover:bg-white dark:hover:bg-slate-700 border border-transparent hover:border-slate-200 dark:hover:border-slate-600 transition-all text-left group premium-card">
        <div class="w-8 h-8 rounded-lg bg-white dark:bg-slate-900 flex items-center justify-center text-slate-500 group-hover:text-emerald-500 transition-colors shadow-sm">
          <i data-feather="user-plus" class="w-4 h-4"></i>
        </div>
        <span class="text-xs font-semibold text-slate-600 dark:text-slate-300">New Client</span>
      </button>

      <button onclick="showSection('payments')" class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800 hover:bg-white dark:hover:bg-slate-700 border border-transparent hover:border-slate-200 dark:hover:border-slate-600 transition-all text-left group premium-card">
        <div class="w-8 h-8 rounded-lg bg-white dark:bg-slate-900 flex items-center justify-center text-slate-500 group-hover:text-green-500 transition-colors shadow-sm">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 3h12"></path>
            <path d="M6 8h12"></path>
            <path d="M6 13l8.5 10"></path>
            <path d="M6 13h3"></path>
            <path d="M9 13c6.627 0 12-5.373 12-12"></path>
          </svg>
        </div>
        <span class="text-xs font-semibold text-slate-600 dark:text-slate-300">Record Payment</span>
      </button>

      <button onclick="showSection('orders')" class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800 hover:bg-white dark:hover:bg-slate-700 border border-transparent hover:border-slate-200 dark:hover:border-slate-600 transition-all text-left group premium-card">
        <div class="w-8 h-8 rounded-lg bg-white dark:bg-slate-900 flex items-center justify-center text-slate-500 group-hover:text-orange-500 transition-colors shadow-sm">
          <i data-feather="shopping-bag" class="w-4 h-4"></i>
        </div>
        <span class="text-xs font-semibold text-slate-600 dark:text-slate-300">View Orders</span>
      </button>

    </div>
  </div>
</div>

<script>
  // Simple script to set the current date
  const d = new Date();
  const options = { weekday: 'long', month: 'short', day: 'numeric' };
  document.getElementById('currentDateDisplay').textContent = d.toLocaleDateString('en-US', options);
  feather.replace(); 
</script>

      <div id="workLog" class="page-section">
        <div id="batchCalculator"></div> 
        <div id="dailyLog" class="mt-8"></div>
      </div>
      <div id="dashboard" class="page-section"></div>
      <div id="recipeCalculator" class="page-section">
  <div class="max-w-5xl mx-auto space-y-6">
    
    <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800">
      <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-indigo-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect>
          <line x1="8" y1="6" x2="16" y2="6"></line>
          <line x1="16" y1="14" x2="16" y2="18"></line>
          <path d="M16 10h.01"></path>
          <path d="M12 10h.01"></path>
          <path d="M8 10h.01"></path>
          <path d="M12 14h.01"></path>
          <path d="M8 14h.01"></path>
          <path d="M12 18h.01"></path>
          <path d="M8 18h.01"></path>
        </svg>
        Recipe Cost Calculator
      </h2>
      
      <form id="recipeForm" class="grid grid-cols-1 md:grid-cols-12 gap-3 items-start mb-4 bg-slate-50 dark:bg-slate-800 p-4 rounded-xl">
        <div class="md:col-span-5">
          <label class="text-xs font-bold text-slate-400">Ingredient</label>
          <input id="ingredientSelect" list="ingredientOptions" type="text" placeholder="Type ingredient name..." class="w-full p-2.5 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 rounded-lg text-sm dark:text-white">
          <datalist id="ingredientOptions"></datalist>
        </div>
        <div class="md:col-span-3">
          <label class="text-xs font-bold text-slate-400">Amount</label>
          <input type="number" id="usedAmount" class="w-full p-2.5 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 rounded-lg text-sm dark:text-white" placeholder="0">
        </div>
        <div class="md:col-span-2">
          <label class="text-xs font-bold text-slate-400">Unit</label>
          <select id="usedUnit" class="w-full p-2.5 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 rounded-lg text-sm dark:text-white"><option value="">Unit</option></select>
        </div>
        <button type="button" id="calcBtn" class="md:col-span-2 w-full md:mt-6 bg-blue-600 text-white px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-blue-700 transition-colors">Add</button>
      </form>
      <div class="overflow-x-auto no-scrollbar mb-4">
      <table class="w-full min-w-[620px] text-sm border dark:border-slate-800 rounded-lg overflow-hidden">
        <thead class="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-900 dark:text-indigo-200">
          <tr>
            <th class="p-2 text-left pl-4">Ingredient</th>
            <th class="p-2 text-center">Qty</th>
            <th class="p-2 text-center">Unit</th>
            <th class="p-2 text-center">Cost</th>
            <th class="p-2 text-center">Action</th>
          </tr>
        </thead>
        <tbody id="costTableBody" class="divide-y divide-indigo-50 dark:divide-indigo-900/20"></tbody>
      </table>
      </div>

      <div class="flex justify-between items-center pt-2 border-t border-slate-100 dark:border-slate-800">
        <button type="button" id="resetCalcBtn" class="hidden px-3 py-1.5 rounded-lg text-xs font-medium text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 border border-transparent transition-all duration-200">
          Reset All
        </button>
        <div id="calcSummaryTotal" class="text-right text-lg font-bold text-slate-800 dark:text-slate-200"></div>
      </div>
    </div>

    <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800">
      <h3 class="text-lg font-bold text-slate-700 dark:text-slate-300 mb-4">Overheads & Profit</h3>
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
        <div><label class="text-xs font-bold text-slate-400">Labour (â¹)</label><input type="number" id="labourCost" class="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 rounded text-sm dark:text-white" value="0"></div>
        <div><label class="text-xs font-bold text-slate-400">Maintenance (â¹)</label><input type="number" id="maintenanceCost" class="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 rounded text-sm dark:text-white" value="0"></div>
        <div><label class="text-xs font-bold text-slate-400">Licensing (â¹)</label><input type="number" id="licensingCost" class="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 rounded text-sm dark:text-white" value="0"></div>
        <div><label class="text-xs font-bold text-slate-400">Packaging (â¹)</label><input type="number" id="packagingCost" class="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 rounded text-sm dark:text-white" value="0"></div>
        <div><label class="text-xs font-bold text-slate-400">Electricity (â¹)</label><input type="number" id="electricityCost" class="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 rounded text-sm dark:text-white" value="0"></div>
        <div><label class="text-xs font-bold text-slate-400">Profit Margin (%)</label><input type="number" id="profitPercent" class="w-full p-2 border rounded text-sm bg-green-50 border-green-200 dark:bg-green-900/30 dark:border-green-800 dark:text-green-100" value="20"></div>
      </div>
      <div class="flex gap-3 mb-4">
        <button id="calcFinalBtn" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg shadow-green-200 dark:shadow-none">Calculate Final Price</button>
        <button id="resetFinalBtn" class="px-4 bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-slate-600">Clear</button>
      </div>
      <div id="finalSummary" class="text-center"></div>
    </div>

  </div>
</div>
      <div id="invoice" class="page-section">
        <div id="invoicePrintArea"></div>
      </div>
      <div id="payments" class="page-section"></div>
      <div id="orders" class="page-section"></div>

<div id="eventsStall" class="page-section">
  
  <div id="eventsListView" class="animate-fade-in">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
      <div>
        <h2 class="text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight">Events & Pop-ups</h2>
        <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">Manage revenue and costs for external stalls.</p>
      </div>
      <button onclick="openEventCalculator()" class="group bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-2xl text-sm font-bold shadow-lg shadow-blue-500/30 transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
        <i data-feather="plus-circle" class="w-5 h-5 group-hover:rotate-90 transition-transform"></i> 
        <span>New Event</span>
      </button>
    </div>

    <div id="eventsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="col-span-full py-20 flex flex-col items-center justify-center text-center">
        <div class="w-24 h-24 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4">
            <i data-feather="map-pin" class="w-10 h-10 text-slate-300 dark:text-slate-600"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200">No events found</h3>
        <p class="text-slate-400 text-sm max-w-xs mx-auto mt-2">Start by recording your first market, pop-up, or catering event.</p>
      </div>
    </div>
  </div>

  <div id="eventDetailView" class="hidden">
    <div class="flex items-center gap-4 mb-8">
      <button onclick="closeEventCalculator()" class="p-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-xl transition-colors shadow-sm group">
        <i data-feather="arrow-left" class="w-5 h-5 text-slate-500 group-hover:text-slate-800 dark:text-slate-400 dark:group-hover:text-white"></i>
      </button>
      <div class="flex-1">
          <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Event Name</label>
          <input type="text" id="eventNameInput" placeholder="E.g. Sunday Farmers Market" class="w-full bg-transparent text-3xl font-extrabold text-slate-800 dark:text-white placeholder-slate-300 dark:placeholder-slate-600 border-none focus:ring-0 p-0 m-0" />
      </div>
      <div>
           <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 text-right">Date</label>
           <input type="date" id="eventDateInput" class="bg-slate-100 dark:bg-slate-800 border-none rounded-lg px-4 py-2 text-sm font-semibold text-slate-700 dark:text-slate-200 outline-none focus:ring-2 focus:ring-blue-500">
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <div class="lg:col-span-2 space-y-6">
        
        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
          <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/30">
            <div>
                <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                <i data-feather="package" class="w-5 h-5 text-blue-500"></i> Sales Inventory
                </h3>
                <p class="text-xs text-slate-500 mt-1">Track opening and closing stock.</p>
            </div>
            <button onclick="addEventRow()" class="text-xs font-bold bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/30 dark:hover:bg-blue-900/50 text-blue-600 dark:text-blue-400 px-4 py-2 rounded-lg transition-colors uppercase tracking-wide">
              + Add Item
            </button>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="bg-slate-50 dark:bg-slate-800/80 text-xs text-slate-500 dark:text-slate-400 uppercase font-bold tracking-wider">
                <tr>
                  <th class="p-5 min-w-[180px]">Item Details</th>
                  <th class="p-5 w-24 text-center">Open</th>
                  <th class="p-5 w-24 text-center">Close</th>
                  <th class="p-5 w-24 text-center text-blue-600 dark:text-blue-400 bg-blue-50/50 dark:bg-blue-900/10">Sold</th>
                  <th class="p-5 w-28 text-right">Price</th>
                  <th class="p-5 w-32 text-right">Revenue</th>
                  <th class="p-5 w-12"></th>
                </tr>
              </thead>
              <tbody id="eventTableBody" class="divide-y divide-slate-100 dark:divide-slate-800">
                </tbody>
            </table>
          </div>
          <div class="p-4 bg-slate-50 dark:bg-slate-800/30 border-t border-slate-100 dark:border-slate-800 text-center">
             <p class="text-xs text-slate-400 flex items-center justify-center gap-2">
               <i data-feather="info" class="w-3 h-3"></i> 
               Auto-calculated: Sold = Open - Close
             </p>
           </div>
        </div>

        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-800 p-6">
          <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-6 flex items-center gap-2">
            <i data-feather="credit-card" class="w-5 h-5 text-orange-500"></i> Event Expenses
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 focus-within:border-orange-400 focus-within:ring-1 focus-within:ring-orange-400 transition-all">
              <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-2 block">Stall Rent</label>
              <div class="flex items-center">
                  <span class="text-slate-400 mr-2">â¹</span>
                  <input type="number" id="eventRent" oninput="calculateEventTotals()" placeholder="0" class="w-full bg-transparent font-bold text-slate-700 dark:text-white outline-none">
              </div>
            </div>
            <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 focus-within:border-orange-400 focus-within:ring-1 focus-within:ring-orange-400 transition-all">
              <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-2 block">Transport</label>
              <div class="flex items-center">
                  <span class="text-slate-400 mr-2">â¹</span>
                  <input type="number" id="eventTransport" oninput="calculateEventTotals()" placeholder="0" class="w-full bg-transparent font-bold text-slate-700 dark:text-white outline-none">
              </div>
            </div>
            <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 focus-within:border-orange-400 focus-within:ring-1 focus-within:ring-orange-400 transition-all">
              <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-2 block">Staff / Labour</label>
              <div class="flex items-center">
                  <span class="text-slate-400 mr-2">â¹</span>
                  <input type="number" id="eventStaff" oninput="calculateEventTotals()" placeholder="0" class="w-full bg-transparent font-bold text-slate-700 dark:text-white outline-none">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="lg:col-span-1">
        <div class="sticky top-24 space-y-4">
          
          <div class="bg-slate-900 text-white p-8 rounded-[2rem] shadow-2xl relative overflow-hidden group">
            <div class="absolute top-0 right-0 w-40 h-40 bg-blue-500 opacity-20 rounded-full blur-3xl -mt-10 -mr-10 group-hover:opacity-30 transition-opacity duration-700"></div>
            <div class="absolute bottom-0 left-0 w-32 h-32 bg-emerald-500 opacity-10 rounded-full blur-3xl -mb-10 -ml-10 group-hover:opacity-20 transition-opacity duration-700"></div>
            
            <div class="relative z-10">
              <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Net Profit</p>
              <h2 id="eventNetProfit" class="text-5xl font-black tracking-tighter mb-1">â¹0</h2>
              <p id="profitMarginLabel" class="text-sm font-medium text-emerald-400 mb-8">Calculated after expenses</p>
              
              <div class="space-y-3 pt-6 border-t border-white/10">
                <div class="flex justify-between items-center text-sm">
                  <span class="text-slate-400">Total Revenue</span>
                  <span id="eventTotalRevenue" class="font-bold text-white">â¹0</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                   <span class="text-slate-400">Ingredient Cost (COGS)</span>
                   <span id="eventCOGS" class="font-medium text-red-300">â¹0</span>
                </div>
                 <div class="flex justify-between items-center text-sm">
                   <span class="text-slate-400">Total Expenses</span>
                   <span id="eventTotalExpenses" class="font-medium text-orange-300">â¹0</span>
                </div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-3">
              <button onclick="saveEvent()" class="w-full py-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-2xl font-bold shadow-lg shadow-emerald-500/20 active:scale-95 transition-all flex justify-center items-center gap-2">
                <i data-feather="save"></i> Save Event
              </button>
              <button onclick="closeEventCalculator()" class="w-full py-3 bg-white dark:bg-slate-800 text-slate-500 hover:text-red-500 dark:text-slate-400 rounded-xl font-medium transition-colors text-sm">
                Discard Changes
              </button>
          </div>
          
        </div>
      </div>

    </div>
  </div>
</div>

      <div id="inventory" class="page-section">
  <div class="max-w-5xl mx-auto">
    <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800">
      <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2">
        <i data-feather="database" class="w-5 h-5 text-blue-500"></i> Ingredient Database
      </h2>
      
      <form id="addEditIngredientForm" class="flex flex-col md:flex-row gap-4 items-center mb-8 bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-800">
        <h3 id="ingredientFormTitle" class="hidden">Add Ingredient</h3>

        <div class="relative w-full md:flex-1">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i data-feather="tag" class="w-4 h-4 text-slate-400"></i>
          </div>
          <input type="text" id="ingredientName" placeholder="Ingredient Name" 
            class="w-full pl-10 pr-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm placeholder-slate-400" required>
        </div>

        <div class="grid grid-cols-3 gap-2 w-full md:w-auto shrink-0">
          <input type="number" id="ingredientSize" placeholder="Size" 
            class="w-full px-3 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm text-center" required>
          
          <div class="relative">
            <select id="ingredientUnit" 
              class="w-full px-3 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-bold text-slate-600 dark:text-slate-300 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm appearance-none text-center cursor-pointer">
              <option value="g">g</option>
              <option value="kg">kg</option>
              <option value="ml">ml</option>
              <option value="L">L</option>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none text-slate-400">
              <i data-feather="chevron-down" class="w-3 h-3"></i>
            </div>
          </div>

          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 font-sans">â¹</span>
            <input type="number" id="ingredientCost" placeholder="Cost" 
              class="w-full pl-7 pr-3 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm" required>
          </div>
        </div>

        <div class="flex gap-2 w-full md:w-auto shrink-0">
          <button type="submit" id="ingredientFormBtn" 
            class="flex-1 md:flex-none px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-sm font-bold shadow-lg shadow-blue-500/30 transition-all hover:scale-105 active:scale-95">
            Add
          </button>
          <button type="button" id="cancelEditBtn" 
            class="flex-1 md:flex-none px-4 py-3 bg-white dark:bg-slate-800 text-slate-500 hover:text-red-500 border border-slate-200 dark:border-slate-700 hover:border-red-200 dark:hover:border-red-900/50 rounded-xl text-sm font-medium transition-all">
            <i data-feather="x" class="w-4 h-4"></i>
          </button>
        </div>
      </form>

      <div class="overflow-auto max-h-[600px] border dark:border-slate-800 rounded-lg">
        <table class="w-full text-sm text-left">
          <thead class="bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 font-semibold sticky top-0 z-10">
            <tr>
              <th class="p-4 text-left">Name</th>
              <th class="p-4 text-center">Size</th>
              <th class="p-4 text-center">Unit</th>
              <th class="p-4 text-center">â¹ Cost</th>
              <th class="p-4 text-center">Action</th>
            </tr>
          </thead>
          <tbody id="ingredientsTableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
      <div id="clients" class="page-section"></div>
      <div id="fixedExpenses" class="page-section">
        <div class="p-12 text-center text-slate-400">
          <i data-feather="dollar-sign" class="w-12 h-12 mx-auto mb-4 text-slate-300 dark:text-slate-600"></i>
          <h2 class="text-lg font-semibold">Fixed Expenses Module</h2>
          <p>Coming Soon</p>
        </div>
      </div>
      <div id="admin" class="page-section">
        <div class="max-w-6xl mx-auto space-y-6">
          <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                  <i data-feather="settings" class="w-6 h-6 text-slate-500"></i>
                  Admin
                </h2>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Workspace controls, access, and defaults.</p>
              </div>
              <button class="px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors">
                Save Changes
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 space-y-4">
              <h3 class="text-sm font-bold uppercase tracking-wider text-slate-500">Business Defaults</h3>
              <div>
                <label class="block text-xs font-semibold text-slate-500 mb-1">Business Name</label>
                <input type="text" placeholder="Lush Patisserie" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm">
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-500 mb-1">Default Currency</label>
                <select class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm">
                  <option>INR (Rs)</option>
                  <option>USD ($)</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-500 mb-1">Invoice Prefix</label>
                <input type="text" placeholder="LP-" class="w-full px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm">
              </div>
            </div>

            <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 space-y-4">
              <h3 class="text-sm font-bold uppercase tracking-wider text-slate-500">Access & Roles</h3>
              <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-800">
                <div>
                  <p class="text-sm font-semibold text-slate-700 dark:text-slate-200">Allow Staff Edits</p>
                  <p class="text-xs text-slate-500">Staff can edit inventory and orders.</p>
                </div>
                <input type="checkbox" checked class="h-4 w-4">
              </div>
              <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-800">
                <div>
                  <p class="text-sm font-semibold text-slate-700 dark:text-slate-200">Require Confirm Before Delete</p>
                  <p class="text-xs text-slate-500">Prevents accidental removal of records.</p>
                </div>
                <input type="checkbox" checked class="h-4 w-4">
              </div>
              <button class="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm font-semibold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                Manage Team
              </button>
            </div>
          </div>
        </div>
      </div>
      <div id="export" class="page-section">
        <div class="p-12 text-center text-slate-400">
          <i data-feather="upload-cloud" class="w-12 h-12 mx-auto mb-4 text-slate-300 dark:text-slate-600"></i>
          <h2 class="text-lg font-semibold">Data Export</h2>
          <p>Download your data as CSV/PDF here.</p>
        </div>
      </div>
    </div>
  </main>

  <div id="commandPalette" class="command-dialog fixed inset-0 z-[180] hidden">
    <div id="commandPaletteBackdrop" class="absolute inset-0 bg-slate-900/45 backdrop-blur-sm"></div>
    <div class="relative mx-auto mt-20 w-[92%] max-w-2xl rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-2xl overflow-hidden">
      <div class="flex items-center gap-3 px-4 py-3 border-b border-slate-200 dark:border-slate-800">
        <i data-feather="search" class="w-4 h-4 text-slate-400"></i>
        <input id="commandInput" type="text" autocomplete="off" placeholder="Search sections and quick actions..." class="w-full bg-transparent text-sm text-slate-700 dark:text-slate-100 placeholder:text-slate-400 focus:outline-none" />
        <span class="text-[10px] px-1.5 py-0.5 rounded border border-slate-300 dark:border-slate-600 text-slate-400">ESC</span>
      </div>
      <div id="commandList" class="max-h-[360px] overflow-y-auto p-2"></div>
    </div>
  </div>

  <script src="js/firebase.js"></script>
  <script src="js/batch.js"></script> 
  <script src="js/dailyLog.js"></script>
  <script src="js/dashboard.js"></script>
  <script src="js/calculations.js"></script>
  <script src="js/inventory.js"></script>
  <script src="js/clients.js"></script>
  <script src="js/invoices.js"></script>
  <script src="js/payments.js"></script>
  <script src="js/orders.js"></script>
  <script src="js/events.js"></script>
  <script src="js/profile.js"></script>
  <script src="js/clientPortal.js" type="module"></script>

  <script>
    // --- Global UI Controller ---
    feather.replace();

    // --- VANILLA TILT 3D CARDS ---
    if (typeof VanillaTilt !== 'undefined') {
        VanillaTilt.init(document.querySelectorAll(".tilt-card"), {
            max: 12,
            speed: 400,
            glare: true,
            "max-glare": 0.4,
            scale: 1.02,
            gyroscope: false
        });
    }

    // DOM Elements
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const toggleBtn = document.getElementById('toggleSidebarBtn');
    const mobileBtn = document.getElementById('sidebarToggleMobile');
    const overlay = document.getElementById('sidebarOverlay');
    const closeMobile = document.getElementById('closeSidebarMobile');
    const themeBtn = document.getElementById('darkModeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const toggleIcon = document.getElementById('toggleIcon');
    const topHeader = document.getElementById('topHeader');
    const sectionProgress = document.getElementById('sectionProgress');
    const commandPalette = document.getElementById('commandPalette');
    const commandBackdrop = document.getElementById('commandPaletteBackdrop');
    const commandInput = document.getElementById('commandInput');
    const commandList = document.getElementById('commandList');
    const heroCommandTrigger = document.getElementById('heroCommandTrigger');
    const commandPaletteTriggerMobile = document.getElementById('commandPaletteTriggerMobile');
    const activeSectionLabel = document.getElementById('activeSectionLabel');
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

   // --- Brand Modal Logic ---
    const brandModal = document.getElementById('brandModal');
    const brandBackdrop = document.getElementById('brandBackdrop');
    const brandLogo = document.getElementById('brandModalLogo');
    const brandText = document.getElementById('brandModalText');
    let isModalOpen = false;

    window.openBrandModal = function() {
        if(isModalOpen) return;
        isModalOpen = true;

        // Display Flex
        brandModal.classList.remove('hidden');
        brandModal.classList.add('flex');
        
        // Fade in Backdrop
        // specific timeout to allow display:flex to apply before opacity transition
        setTimeout(() => brandBackdrop.classList.remove('opacity-0'), 10);

        // Reset Animations
        brandLogo.classList.remove('animate-brand-logo-out');
        brandText.classList.remove('animate-brand-text-out');
        
        // Trigger Reflow
        void brandLogo.offsetWidth; 
        
        // Add Entry Animations
        brandLogo.classList.add('animate-brand-logo');
        brandText.classList.add('animate-brand-text');
    };

    window.closeBrandModal = function() {
        if(!isModalOpen) return;
        isModalOpen = false;

        // Add Exit Animations
        brandLogo.classList.remove('animate-brand-logo');
        brandLogo.classList.add('animate-brand-logo-out');
        
        brandText.classList.remove('animate-brand-text');
        brandText.classList.add('animate-brand-text-out');

        // Fade out Backdrop
        brandBackdrop.classList.add('opacity-0');

        // Wait for animation to finish before hiding (500ms matches CSS duration)
        setTimeout(() => {
            brandModal.classList.add('hidden');
            brandModal.classList.remove('flex');
        }, 500); 
    };

    // Close on Click
    brandModal.addEventListener('click', window.closeBrandModal);

    // Close on ESC Key
    document.addEventListener('keydown', (e) => {
        if (e.key === "Escape" && isModalOpen) {
            window.closeBrandModal();
        }
    });

    function updateHeaderState() {
      if (!topHeader) return;
      topHeader.classList.toggle('is-scrolled', window.scrollY > 10);
    }
    window.addEventListener('scroll', updateHeaderState, { passive: true });
    updateHeaderState();

    // --- 1. PERSISTENCE LOGIC (Sidebar) ---
    const SIDEBAR_STATE_KEY = 'sidebarState';
    const savedState = localStorage.getItem(SIDEBAR_STATE_KEY);
    let isCollapsed = savedState === 'collapsed';

    const setToggleIcon = (collapsed) => {
        if (collapsed) {
            toggleIcon.innerHTML = '<polyline points="9 18 15 12 9 6"></polyline>'; 
        } else {
            toggleIcon.innerHTML = '<polyline points="15 18 9 12 15 6"></polyline>';
        }
    }

    if (isCollapsed) {
      sidebar.classList.add('collapsed');
      mainContent.classList.remove('md:pl-[17rem]');
      mainContent.classList.add('md:pl-20');
      setToggleIcon(true);
    } else {
      setToggleIcon(false);
    }
    feather.replace();

    toggleBtn?.addEventListener('click', () => {
      isCollapsed = !isCollapsed;
      if(isCollapsed) {
        sidebar.classList.add('collapsed');
        mainContent.classList.remove('md:pl-[17rem]');
        mainContent.classList.add('md:pl-20');
        setToggleIcon(true);
      } else {
        sidebar.classList.remove('collapsed');
        mainContent.classList.remove('md:pl-20');
        mainContent.classList.add('md:pl-[17rem]');
        setToggleIcon(false);
      }
      localStorage.setItem(SIDEBAR_STATE_KEY, isCollapsed ? 'collapsed' : 'expanded');
      feather.replace();
    });

    // --- 2. DARK MODE LOGIC ---
    const THEME_KEY = 'themePreference';
    const savedTheme = localStorage.getItem(THEME_KEY);
    const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

    function applyTheme(isDark) {
      if (isDark) {
        document.documentElement.classList.add('dark');
        themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>'; 
      } else {
        document.documentElement.classList.remove('dark');
        themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>'; 
      }
      feather.replace();
    }

    if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
      applyTheme(true);
    } else {
      applyTheme(false);
    }

    themeBtn?.addEventListener('click', () => {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
      applyTheme(isDark);
      scheduleTooltipInit(0);
    });

    // --- 3. MOBILE MENU ---
    mobileBtn?.addEventListener('click', () => {
      sidebar.classList.add('open');
      overlay.classList.remove('hidden');
    });
    const closeSidebar = () => {
      sidebar.classList.remove('open');
      overlay.classList.add('hidden');
    };
    closeMobile?.addEventListener('click', closeSidebar);
    overlay?.addEventListener('click', closeSidebar);

    // --- 4. NAVIGATION ---
    // Added "eventsStall" to this list so the app knows to hide/show it
    const sections = ["home", "workLog", "dashboard", "recipeCalculator", "invoice", "payments", "orders", "eventsStall", "inventory", "clients", "fixedExpenses", "admin", "export"];
    const sectionMeta = {
      home: { label: 'Home', icon: 'home' },
      workLog: { label: 'Work Log', icon: 'edit-3' },
      dashboard: { label: 'Dashboard', icon: 'pie-chart' },
      recipeCalculator: { label: 'Recipe Calculator', icon: 'calculator' },
      invoice: { label: 'Invoice', icon: 'file-text' },
      payments: { label: 'Payments', icon: 'credit-card' },
      orders: { label: 'Orders', icon: 'shopping-bag' },
      eventsStall: { label: 'Events & Stalls', icon: 'map-pin' },
      inventory: { label: 'Inventory', icon: 'package' },
      clients: { label: 'Clients', icon: 'users' },
      fixedExpenses: { label: 'Fixed Expenses', icon: 'database' },
      admin: { label: 'Admin', icon: 'shield' },
      export: { label: 'Export', icon: 'upload-cloud' }
    };
    const quickActions = [
      { id: 'quick-dashboard', label: 'Open Dashboard', section: 'dashboard', icon: 'bar-chart-2' },
      { id: 'quick-new-invoice', label: 'Create Invoice', section: 'invoice', icon: 'file-plus' },
      { id: 'quick-payments', label: 'Record Payment', section: 'payments', icon: 'credit-card' },
      { id: 'quick-inventory', label: 'Manage Inventory', section: 'inventory', icon: 'package' }
    ];
    const DEFAULT_SECTION = 'home';
    const REFRESH_MODE_KEY = 'flowr:refreshMode';
    const ROLE_FALLBACK_SECTION = 'home';
    const getNavLinks = () => document.querySelectorAll('#sidebar .nav-link');
    window.RolePortal?.snapshotDefaultSidebar?.();

    function persistRefreshIntent(mode) {
      try {
        sessionStorage.setItem(REFRESH_MODE_KEY, mode);
      } catch (_) {}
    }

    function consumeRefreshIntent() {
      try {
        const mode = sessionStorage.getItem(REFRESH_MODE_KEY);
        sessionStorage.removeItem(REFRESH_MODE_KEY);
        return mode;
      } catch (_) {
        return null;
      }
    }

    function syncSectionHash(id) {
      if (!sections.includes(id)) return;
      const nextHash = id === DEFAULT_SECTION ? '' : `#${id}`;
      const nextUrl = `${window.location.pathname}${window.location.search}${nextHash}`;
      window.history.replaceState(null, '', nextUrl);
    }

    function resolveInitialSection() {
      const hardRefresh = consumeRefreshIntent() === 'hard';
      if (hardRefresh) return DEFAULT_SECTION;

      const hashSection = window.location.hash.substring(1);
      if (sections.includes(hashSection)) return hashSection;

      return DEFAULT_SECTION;
    }

    function updateSectionProgress(id) {
      if (!sectionProgress) return;
      const idx = sections.indexOf(id);
      const pct = idx >= 0 ? ((idx + 1) / sections.length) * 100 : 0;
      sectionProgress.style.width = `${Math.max(8, Math.min(100, pct))}%`;
    }

    function applyRoleGuards() {
      const access = window.AccessControl;
      if (!access?.canAccessSection) return;

      getNavLinks().forEach(link => {
        const href = link.getAttribute('href') || '';
        const sectionId = href.startsWith('#') ? href.substring(1) : '';
        const allowed = access.canAccessSection(sectionId);
        link.style.display = allowed ? '' : 'none';
      });

      document.querySelectorAll('[data-quick-section]').forEach((btn) => {
        const sectionId = btn.getAttribute('data-quick-section') || '';
        const allowed = access.canAccessSection(sectionId);
        btn.style.display = allowed ? '' : 'none';
      });
    }

    function getSectionSkeletonMarkup(id) {
      const wrappers = {
        base: 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl',
        card: 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl'
      };

      if (id === 'dashboard') {
        return `
          <div class="max-w-6xl mx-auto space-y-6 p-1">
            <div class="${wrappers.base} p-6">
              <div class="h-5 w-52 rounded-lg section-skeleton"></div>
              <div class="mt-3 h-3 w-72 rounded-md section-skeleton"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="h-28 ${wrappers.card} p-4"><div class="h-3 w-24 rounded-md section-skeleton"></div><div class="mt-4 h-8 w-20 rounded-lg section-skeleton"></div></div>
              <div class="h-28 ${wrappers.card} p-4"><div class="h-3 w-28 rounded-md section-skeleton"></div><div class="mt-4 h-8 w-24 rounded-lg section-skeleton"></div></div>
              <div class="h-28 ${wrappers.card} p-4"><div class="h-3 w-20 rounded-md section-skeleton"></div><div class="mt-4 h-8 w-16 rounded-lg section-skeleton"></div></div>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
              <div class="${wrappers.base} p-5">
                <div class="h-4 w-32 rounded-md section-skeleton"></div>
                <div class="mt-5 h-56 rounded-xl section-skeleton"></div>
              </div>
              <div class="${wrappers.base} p-5">
                <div class="h-4 w-36 rounded-md section-skeleton"></div>
                <div class="mt-5 h-56 rounded-xl section-skeleton"></div>
              </div>
            </div>
          </div>
        `;
      }

      if (id === 'payments' || id === 'orders') {
        return `
          <div class="max-w-6xl mx-auto space-y-6 p-1">
            <div class="${wrappers.base} p-6">
              <div class="h-5 w-44 rounded-lg section-skeleton"></div>
              <div class="mt-3 h-3 w-64 rounded-md section-skeleton"></div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="h-24 ${wrappers.card} p-4"><div class="h-3 w-16 rounded-md section-skeleton"></div><div class="mt-3 h-7 w-20 rounded-lg section-skeleton"></div></div>
              <div class="h-24 ${wrappers.card} p-4"><div class="h-3 w-20 rounded-md section-skeleton"></div><div class="mt-3 h-7 w-16 rounded-lg section-skeleton"></div></div>
              <div class="h-24 ${wrappers.card} p-4"><div class="h-3 w-14 rounded-md section-skeleton"></div><div class="mt-3 h-7 w-24 rounded-lg section-skeleton"></div></div>
              <div class="h-24 ${wrappers.card} p-4"><div class="h-3 w-24 rounded-md section-skeleton"></div><div class="mt-3 h-7 w-12 rounded-lg section-skeleton"></div></div>
            </div>
            <div class="${wrappers.base} p-5 space-y-3">
              <div class="h-10 rounded-lg section-skeleton"></div>
              <div class="h-10 rounded-lg section-skeleton"></div>
              <div class="h-10 rounded-lg section-skeleton"></div>
              <div class="h-10 rounded-lg section-skeleton"></div>
              <div class="h-10 rounded-lg section-skeleton"></div>
            </div>
          </div>
        `;
      }

      if (id === 'clients') {
        return `
          <div class="max-w-6xl mx-auto space-y-6 p-1">
            <div class="${wrappers.base} p-6">
              <div class="h-5 w-40 rounded-lg section-skeleton"></div>
              <div class="mt-3 h-3 w-72 rounded-md section-skeleton"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
              <div class="${wrappers.card} p-5">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-full section-skeleton"></div>
                  <div class="space-y-2 w-full">
                    <div class="h-3 w-1/2 rounded-md section-skeleton"></div>
                    <div class="h-3 w-2/3 rounded-md section-skeleton"></div>
                  </div>
                </div>
                <div class="mt-5 h-3 w-full rounded-md section-skeleton"></div>
                <div class="mt-2 h-3 w-[85%] rounded-md section-skeleton"></div>
              </div>
              <div class="${wrappers.card} p-5">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-full section-skeleton"></div>
                  <div class="space-y-2 w-full">
                    <div class="h-3 w-1/2 rounded-md section-skeleton"></div>
                    <div class="h-3 w-2/3 rounded-md section-skeleton"></div>
                  </div>
                </div>
                <div class="mt-5 h-3 w-full rounded-md section-skeleton"></div>
                <div class="mt-2 h-3 w-[85%] rounded-md section-skeleton"></div>
              </div>
              <div class="${wrappers.card} p-5">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-full section-skeleton"></div>
                  <div class="space-y-2 w-full">
                    <div class="h-3 w-1/2 rounded-md section-skeleton"></div>
                    <div class="h-3 w-2/3 rounded-md section-skeleton"></div>
                  </div>
                </div>
                <div class="mt-5 h-3 w-full rounded-md section-skeleton"></div>
                <div class="mt-2 h-3 w-[85%] rounded-md section-skeleton"></div>
              </div>
            </div>
          </div>
        `;
      }

      return `
        <div class="max-w-6xl mx-auto p-1">
          <div class="${wrappers.base} p-6 space-y-3">
            <div class="h-5 w-44 rounded-lg section-skeleton"></div>
            <div class="h-3 w-72 rounded-md section-skeleton"></div>
            <div class="h-40 rounded-xl section-skeleton mt-4"></div>
          </div>
        </div>
      `;
    }

    function setActiveSectionLabel(id) {
      if (!activeSectionLabel) return;
      const next = sectionMeta[id]?.label || 'Home';
      if (activeSectionLabel.textContent === next) return;

      activeSectionLabel.classList.add('is-swapping');
      setTimeout(() => {
        activeSectionLabel.textContent = next;
        activeSectionLabel.classList.remove('is-swapping');
      }, 140);
    }

    function showSection(id, options = {}) {
      const shouldSyncHash = options.syncHash !== false;
      const isAuthenticated = !!window.auth?.currentUser;
      if (isAuthenticated && window.AccessControl?.canAccessSection && !window.AccessControl.canAccessSection(id)) {
        if(window.notyf) window.notyf.error('You do not have access to this section.');
        id = ROLE_FALLBACK_SECTION;
      }

      // Reset scroll so each tab opens from the top instead of preserving the previous tab's scroll position.
      window.scrollTo({ top: 0, behavior: 'auto' });

      sections.forEach(s => {
        const el = document.getElementById(s);
        if(el) {
          el.classList.remove('show');
          setTimeout(() => { if(!el.classList.contains('show')) el.style.display = 'none'; }, 300);
        }
      });
      
      setTimeout(() => {
        const target = document.getElementById(id);
        if(target) {
          target.style.display = 'block';
          void target.offsetWidth;
          target.classList.add('show');

          if (['dashboard', 'payments', 'orders', 'clients'].includes(id)) {
            target.innerHTML = getSectionSkeletonMarkup(id);
          }
          
          if (id === 'clients' && window.renderClientsSection) window.renderClientsSection();
          if (id === 'admin' && window.AdminPortal?.render) window.AdminPortal.render();
          if (id === 'orders' && window.renderOrdersTable) window.renderOrdersTable();
          if (id === 'dashboard' && window.loadDashboard) window.loadDashboard();
          if (id === 'payments' && window.renderPaymentsTable) window.renderPaymentsTable();
        }
      }, 50);

      getNavLinks().forEach(l => {
        l.classList.remove('active');
        l.removeAttribute('aria-current');
        l.classList.add('text-slate-600', 'dark:text-slate-400'); 
      });
      
      const activeLink = document.querySelector(`a[href="#${id}"]`);
      if(activeLink) {
        activeLink.classList.add('active');
        activeLink.setAttribute('aria-current', 'page');
        activeLink.classList.remove('text-slate-600', 'dark:text-slate-400');
      }

      setActiveSectionLabel(id);

      if (shouldSyncHash) syncSectionHash(id);
      updateSectionProgress(id);
      
      if(window.innerWidth < 768) closeSidebar();
    }
    window.showSection = showSection;

    function bindNavHandlers() {
      const navContainer = document.querySelector('#sidebar nav');
      if (!navContainer || navContainer.dataset.navBound === '1') return;

      navContainer.dataset.navBound = '1';
      navContainer.addEventListener('click', (e) => {
        const link = e.target.closest('a.nav-link');
        if (!link || !navContainer.contains(link)) return;

        const href = link.getAttribute('href') || '';
        if (!href.startsWith('#')) return;

        e.preventDefault();
        const id = href.substring(1);
        showSection(id);
      });
    }

    bindNavHandlers();

    function initRevealEffects() {
      const revealItems = document.querySelectorAll('[data-reveal]');
      if (prefersReducedMotion) {
        revealItems.forEach((el) => el.classList.add('is-revealed'));
        return;
      }

      const revealObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach((entry) => {
          if (!entry.isIntersecting) return;
          entry.target.classList.add('is-revealed');
          observer.unobserve(entry.target);
        });
      }, { threshold: 0.2, rootMargin: '0px 0px -8% 0px' });

      revealItems.forEach((el) => revealObserver.observe(el));
    }

    function initParallaxEffects() {
      const blobs = document.querySelectorAll('[data-parallax]');
      if (!blobs.length || prefersReducedMotion) return;

      const updateParallax = () => {
        const shift = Math.min(window.scrollY * 0.2, 90);
        blobs.forEach((blob) => {
          const depth = Number(blob.dataset.depth || 0.2);
          blob.style.setProperty('--parallax-depth', depth.toString());
          blob.style.setProperty('--parallax-shift', `${shift}px`);
        });
      };

      window.addEventListener('scroll', updateParallax, { passive: true });
      updateParallax();
    }

    function initMagneticButtons() {
      if (prefersReducedMotion) return;
      document.querySelectorAll('.magnetic-btn').forEach((btn) => {
        btn.addEventListener('mousemove', (event) => {
          const rect = btn.getBoundingClientRect();
          const offsetX = event.clientX - (rect.left + rect.width / 2);
          const offsetY = event.clientY - (rect.top + rect.height / 2);
          btn.style.transform = `translate(${offsetX * 0.08}px, ${offsetY * 0.12}px)`;
        });
        btn.addEventListener('mouseleave', () => {
          btn.style.transform = 'translate(0, 0)';
        });
      });
    }

    function initTopQuickActions() {
      document.querySelectorAll('[data-quick-section]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const sectionId = btn.getAttribute('data-quick-section');
          if (!sectionId) return;
          showSection(sectionId);
        });
      });
    }

    const commandState = {
      open: false,
      items: [],
      activeIndex: 0
    };

    function getAvailableCommandItems(query = '') {
      const q = query.trim().toLowerCase();
      const access = window.AccessControl;
      const isAuthenticated = !!window.auth?.currentUser;
      const canSeeSection = (section) => {
        if (!isAuthenticated || !access?.canAccessSection) return true;
        return access.canAccessSection(section);
      };

      const sectionItems = sections
        .filter((section) => canSeeSection(section))
        .map((section) => ({
          type: 'section',
          id: `section-${section}`,
          section,
          label: sectionMeta[section]?.label || section,
          icon: sectionMeta[section]?.icon || 'arrow-right',
          hint: 'Section'
        }));

      const actionItems = quickActions
        .filter((item) => canSeeSection(item.section))
        .map((item) => ({
          type: 'action',
          id: item.id,
          section: item.section,
          label: item.label,
          icon: item.icon,
          hint: 'Quick Action'
        }));

      const merged = [...actionItems, ...sectionItems];
      if (!q) return merged;
      return merged.filter((item) => item.label.toLowerCase().includes(q));
    }

    function renderCommandList(query = '') {
      if (!commandList) return;
      commandState.items = getAvailableCommandItems(query);
      if (commandState.activeIndex > commandState.items.length - 1) commandState.activeIndex = 0;

      if (!commandState.items.length) {
        commandList.innerHTML = '<div class="px-3 py-6 text-sm text-slate-400 text-center">No matching actions found.</div>';
        return;
      }

      commandList.innerHTML = commandState.items.map((item, idx) => `
        <button type="button" data-command-index="${idx}" class="command-item w-full flex items-center justify-between gap-3 px-3 py-2 text-left rounded-xl border border-transparent ${idx === commandState.activeIndex ? 'active' : ''}">
          <div class="flex items-center gap-3">
            <i data-feather="${item.icon}" class="w-4 h-4 text-slate-400"></i>
            <div>
              <p class="text-sm font-semibold text-slate-700 dark:text-slate-100">${item.label}</p>
              <p class="text-xs text-slate-400">${item.hint}</p>
            </div>
          </div>
          <span class="text-[10px] uppercase tracking-wider text-slate-400">${item.type}</span>
        </button>
      `).join('');

      commandList.querySelectorAll('[data-command-index]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.getAttribute('data-command-index'));
          const selected = commandState.items[idx];
          if (!selected) return;
          closeCommandPalette();
          showSection(selected.section);
        });
      });

      feather.replace();
    }

    function openCommandPalette() {
      if (!commandPalette || commandState.open) return;
      commandState.open = true;
      commandPalette.classList.remove('hidden');
      renderCommandList('');
      if (commandInput) {
        commandInput.value = '';
        commandInput.focus();
      }
    }

    function closeCommandPalette() {
      if (!commandPalette || !commandState.open) return;
      commandState.open = false;
      commandPalette.classList.add('hidden');
    }

    function moveCommandSelection(direction) {
      if (!commandState.items.length) return;
      commandState.activeIndex = (commandState.activeIndex + direction + commandState.items.length) % commandState.items.length;
      renderCommandList(commandInput?.value || '');
    }

    heroCommandTrigger?.addEventListener('click', openCommandPalette);
    commandPaletteTriggerMobile?.addEventListener('click', openCommandPalette);
    commandBackdrop?.addEventListener('click', closeCommandPalette);
    commandInput?.addEventListener('input', (e) => {
      commandState.activeIndex = 0;
      renderCommandList(e.target.value || '');
    });

    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'r') {
        persistRefreshIntent(e.shiftKey ? 'hard' : 'soft');
      }

      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        if (commandState.open) closeCommandPalette();
        else openCommandPalette();
        return;
      }
      if (!commandState.open) return;

      if (e.key === 'Escape') {
        e.preventDefault();
        closeCommandPalette();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        moveCommandSelection(1);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        moveCommandSelection(-1);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        const selected = commandState.items[commandState.activeIndex];
        if (!selected) return;
        closeCommandPalette();
        showSection(selected.section);
      }
    });

    window.addEventListener('hashchange', () => {
      const hashSection = window.location.hash.substring(1);
      if (!sections.includes(hashSection)) return;
      showSection(hashSection, { syncHash: false });
    });

    initRevealEffects();
    initParallaxEffects();
    initMagneticButtons();
    initTopQuickActions();

    // --- 5. TIPPY.JS TOOLTIPS ---
// Initialize Tippy instances variable to manage them later if needed
let tooltipInstances = [];
let tooltipInitTimer = null;
let tooltipNavObserver = null;

function scheduleTooltipInit(delay = 0) {
  clearTimeout(tooltipInitTimer);
  console.log('[tooltips] schedule init', {
    delay,
    collapsed: sidebar?.classList.contains('collapsed'),
    dark: document.documentElement.classList.contains('dark')
  });
  tooltipInitTimer = setTimeout(initTooltips, delay);
}

function initTooltips() {
  if (typeof tippy !== 'function') {
    console.log('[tooltips] skipped: tippy unavailable');
    return;
  }

  // Destroy existing instances to avoid duplicates
  if (tooltipInstances.length > 0) {
    console.log('[tooltips] destroying existing instances', tooltipInstances.length);
    tooltipInstances.forEach(instance => instance.destroy());
    tooltipInstances = [];
  }

  // Only enable tooltips if the sidebar is collapsed
  if (sidebar.classList.contains('collapsed')) {
    const navLinks = document.querySelectorAll('.nav-link[data-tooltip]');
    if (!navLinks.length) {
      console.log('[tooltips] skipped: no nav links found');
      return;
    }

    tooltipInstances = tippy(navLinks, {
      content: (reference) => reference.getAttribute('data-tooltip'),
      placement: 'right',      // Tooltip appears to the right of the icon
      animation: 'fade',       // Crisp appearance (no scale blur)
      theme: 'flowr',
      arrow: true,
      delay: [100, 0],         // Slight delay before showing
      duration: [200, 100],    // Animation speed
      zIndex: 9999
    });
    console.log('[tooltips] initialized', {
      instances: tooltipInstances.length,
      dark: document.documentElement.classList.contains('dark')
    });
  } else {
    console.log('[tooltips] skipped: sidebar expanded');
  }
}

// Re-initialize tooltips whenever the sidebar is toggled
toggleBtn?.addEventListener('click', () => {
    // We rely on the existing event listener to toggle the class, 
    // but we need to update Tippy AFTER the class change.
    scheduleTooltipInit(120); 
});

function observeSidebarNavChanges() {
  const navContainer = document.querySelector('#sidebar nav');
  if (!navContainer || tooltipNavObserver) return;

  tooltipNavObserver = new MutationObserver(() => {
    scheduleTooltipInit(0);
  });

  tooltipNavObserver.observe(navContainer, { childList: true, subtree: true });
}

// Initialize on load
observeSidebarNavChanges();
scheduleTooltipInit(120);
window.addEventListener('load', () => scheduleTooltipInit(0));
window.addEventListener('pageshow', () => scheduleTooltipInit(0));

    // --- 6. GREETING & AUTH & SPLASH SCREEN LOGIC ---
    function updateGreeting(name) {
      const h = new Date().getHours();
      const greet = h < 12 ? 'Good morning' : h < 18 ? 'Good afternoon' : 'Good evening';
      const displayName = name ? name.split(' ')[0] : 'Chef';

      const heroGreeting = document.getElementById('heroGreeting');
      const heroName = document.getElementById('heroName');
      if(heroGreeting && heroName) {
        heroGreeting.innerText = greet;
        heroName.innerText = displayName;
      }
    }

    updateGreeting();

    window.addEventListener('load', () => {
        const loader = document.getElementById('globalLoader');
        const removeLoader = () => {
            loader.classList.add('loader-hidden');
            setTimeout(() => { loader.style.display = 'none'; }, 700);
        };

        if(window.auth) {
            window.auth.onAuthStateChanged(async (user) => {
                if(user) {
                    const accessResult = await window.AccessControl?.handlePostLogin(user);
                    if (accessResult && accessResult.allowed === false) {
                        alert("Access denied: your account is not invited or is currently inactive. Please contact admin.");
                        window.AccessControl?.clearSession?.();
                        applyRoleGuards();
                        await window.auth.signOut();
                        setTimeout(removeLoader, 100);
                        return;
                    }

                    document.getElementById('signInPage').style.display = 'none';
                    document.getElementById('userInfo').classList.remove('hidden');
                    document.getElementById('userInfo').classList.add('flex');
                    document.getElementById('userPhoto').src = user.photoURL || 'assets/LP Logo.png';
                    document.getElementById('userName').innerText = user.displayName;
                    document.getElementById('loginBtn').style.display = 'none';
                    updateGreeting(user.displayName);

                    await window.RolePortal?.activate?.(user, accessResult);
                    bindNavHandlers();
                    applyRoleGuards();
                    scheduleTooltipInit(0);
                    setTimeout(removeLoader, 500); // Slight delay for smoothness
                } else {
                    window.AccessControl?.clearSession?.();
                    window.RolePortal?.resetToDefaultSidebar?.();
                    window.RolePortal?.clearHeaderAffordances?.();
                    bindNavHandlers();
                    document.getElementById('signInPage').style.display = 'block'; // Make sure the container is visible
                    document.getElementById('userInfo').classList.add('hidden');
                    document.getElementById('loginBtn').style.display = 'block';
                    updateGreeting();
                    applyRoleGuards();
                    scheduleTooltipInit(0);
                    removeLoader(); // Immediate removal to show login
                }
            });
        } else {
            removeLoader();
        }
        
        const initialSection = resolveInitialSection();
        showSection(initialSection);
    });

    document.getElementById('signInGoogleBtn')?.addEventListener('click', () => window.auth?.signInWithPopup(window.googleProvider));
    document.getElementById('loginBtn')?.addEventListener('click', () => window.auth?.signInWithPopup(window.googleProvider));
    document.getElementById('logoutBtn')?.addEventListener('click', () => window.auth?.signOut());

    // --- Mouse Spotlight Logic for Login Page ---
    const loginVisuals = document.getElementById('loginVisuals');
    if(loginVisuals) {
        loginVisuals.addEventListener('mousemove', (e) => {
            const rect = loginVisuals.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Set CSS variables for the mask
            loginVisuals.style.setProperty('--mouse-x', `${x}px`);
            loginVisuals.style.setProperty('--mouse-y', `${y}px`);
        });
    }

  </script>
</body>
</html>
